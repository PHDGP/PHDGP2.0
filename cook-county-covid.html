<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>8 Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022) | Public Health Disparities Geocoding Project 2.0 Training Manual</title>
<meta name="author" content="Christian Testa, Jarvis T Chen, Enjoli Hall, Dena Javadi, Justin Morgan, Tamara Rushovich, Sudipta (Shu) Saha, Pamela D Waterman, Nancy Krieger">
<meta name="description" content="8.1 Introduction In this case study, the outcome of interest is COVID-19 mortality in Cook County. The impact of COVID-19 has been marked by inequities by racialized/ethnic group and socioeconomic...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="8 Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022) | Public Health Disparities Geocoding Project 2.0 Training Manual">
<meta property="og:type" content="book">
<meta property="og:description" content="8.1 Introduction In this case study, the outcome of interest is COVID-19 mortality in Cook County. The impact of COVID-19 has been marked by inequities by racialized/ethnic group and socioeconomic...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="8 Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022) | Public Health Disparities Geocoding Project 2.0 Training Manual">
<meta name="twitter:description" content="8.1 Introduction In this case study, the outcome of interest is COVID-19 mortality in Cook County. The impact of COVID-19 has been marked by inequities by racialized/ethnic group and socioeconomic...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1.9000/transition.js"></script><script src="libs/bs3compat-0.3.1.9000/tabs.js"></script><script src="libs/bs3compat-0.3.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet">
<script src="libs/HomeButton-0.0.1/home-button.js"></script><script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script><script src="libs/clipboard-0.0.1/setClipboardText.js"></script><link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet">
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet">
<script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YD7D8SMHNP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-YD7D8SMHNP');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Public Health Disparities Geocoding Project 2.0 Training Manual</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Public Health Disparities Geocoding Project 2.0 Training Manual</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="background.html"><span class="header-section-number">1</span> Background and History of Analytic Methods</a></li>
<li><a class="" href="getting-setup.html"><span class="header-section-number">2</span> Getting Setup with R and RStudio</a></li>
<li><a class="" href="getting-your-data.html"><span class="header-section-number">3</span> Getting your data</a></li>
<li><a class="" href="visualizing-your-data.html"><span class="header-section-number">4</span> Visualizing your data</a></li>
<li><a class="" href="analyzing-your-data.html"><span class="header-section-number">5</span> Analyzing your data</a></li>
<li><a class="" href="premature-mortality.html"><span class="header-section-number">6</span> Case Study 1: Premature Mortality in Massachusetts</a></li>
<li><a class="" href="breast-cancer-mortality.html"><span class="header-section-number">7</span> Case Study 2: Breast Cancer Mortality in Massachusetts</a></li>
<li><a class="active" href="cook-county-covid.html"><span class="header-section-number">8</span> Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022)</a></li>
<li><a class="" href="temporal-health-insurance.html"><span class="header-section-number">9</span> Case Study 4: Case Study on Temporal Trends using American Community Survey (ACS) data (2012-2019)</a></li>
<li><a class="" href="health-insurance-comparison.html"><span class="header-section-number">10</span> Case Study 5: Case Study Comparing County Analyses of Inequities in Health Insurance using ACS vs. CDC PLACES data (2019)</a></li>
<li><a class="" href="conclusions.html"><span class="header-section-number">11</span> Conclusions</a></li>
<li><a class="" href="glossary.html"><span class="header-section-number">12</span> Glossary</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="cook-county-covid" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022)<a class="anchor" aria-label="anchor" href="#cook-county-covid"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-1" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-1"><i class="fas fa-link"></i></a>
</h2>
<p>In this case study, the outcome of interest is COVID-19 mortality in Cook County. The impact of COVID-19 has been marked by inequities by racialized/ethnic group and socioeconomic position. Here we investigate disparities in COVID-19 mortality, with a focus on comparing risks between Black Hispanic and non-Hispanic, White non-Hispanic, and Hispanic populations.</p>
<p>The Cook County Medical Examiner has made a dataset with COVID-19 related deaths publicly available with the following intent:</p>
<blockquote>
<p>Cook County Government has created the Medical Examiner COVID-19 Dashboard to provide direct, transparent access to critical information about COVID-19 deaths in the County for public health agencies, medical professionals, first responders, journalists, policymakers and residents. The Medical Examiner’s Office encourages visitors to use this data to explore trends, identify areas of concern and take appropriate action. The data can be utilized to identify communities that are most severely impacted by the virus and can inform proactive public policy.</p>
</blockquote>
<p>Read more: <a href="https://datacatalog.cookcountyil.gov/stories/s/ttk4-trbu" class="uri">https://datacatalog.cookcountyil.gov/stories/s/ttk4-trbu</a></p>
<p>Data Source: <a href="https://datacatalog.cookcountyil.gov/Public-Safety/Medical-Examiner-Case-Archive-COVID-19-Related-Dea/3trz-enys" class="uri">https://datacatalog.cookcountyil.gov/Public-Safety/Medical-Examiner-Case-Archive-COVID-19-Related-Dea/3trz-enys</a></p>
<p>The death records in this dataset includes individual-level fields for “Race” and “Latino”, from which we obtain social membership in racialized/ethnic groups. The dataset also includes residential Zip Codes, which we can use to link to area-based social measures (ABSMs) from the American Community Survey (ACS) 2015-19. We will explore how membership in racialized/ethnic groups and ABSMs is associated with COVID-19 mortality.</p>
</div>
<div id="motivation-research-questions-and-learning-objectives-2" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Motivation, Research Questions, and Learning Objectives<a class="anchor" aria-label="anchor" href="#motivation-research-questions-and-learning-objectives-2"><i class="fas fa-link"></i></a>
</h2>
<p>This case study focuses on the following research questions:</p>
<ul>
<li><p>What are the differences in COVID-19 mortality rates by racialized group accounting for age?</p></li>
<li><p>What are the gradients in overall COVID-19 mortality in relation to ABSMs measuring: racialized group composition, the ICE for racialized economic segregation, percent of population living below the poverty line, percent of people living in crowded housing, and median income;</p></li>
<li><p>What are the gradients in COVID-19 mortality by racialized group in relation to the ABSMs</p></li>
<li><p>What is the spatial variation in COVID-19 mortality by racialized group?</p></li>
</ul>
<p>In today’s case example using these data, we’ll show you how you can use the <code>tidycensus</code> package to download relevant area based population estimates and sociodemographic measures from the ACS.</p>
<div class="infobox dataWrangling">
<p>We’ll show you how we cleaned the data and merged in data from the ACS in the <strong>Cleaning the Data</strong> section. However, we’re also providing you a cleaned dataset that should allow you to pick up and follow along from the <strong>Visualizing Your Data</strong> section onwards.</p>
</div>
</div>
<div id="approach-2" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Approach<a class="anchor" aria-label="anchor" href="#approach-2"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>To look at overall differences in COVID-19 mortality by racialized group, we will model aggregate mortality rates across Cook County by racialized group</p></li>
<li><p>To look at gradients in relation to ABSMs, we will model overall ZCTA-level mortality rates for each ABSM of interest.</p></li>
<li><p>To look at gradients in relation to ABSMs by racialized group, we will model ZCTA-level mortality separately for each racialized group and each ABSM.</p></li>
<li><p>To explore spatial variation we will use spatial models.</p></li>
</ul>
</div>
<div id="dependencies-2" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Dependencies<a class="anchor" aria-label="anchor" href="#dependencies-2"><i class="fas fa-link"></i></a>
</h2>
<p>These are the packages that you will need to run the code in this case example. Once you copy and run the code below to load the dependencies, you can jump ahead to the <strong>Visualizing Your Data</strong> Section if you want.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mission critical packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://walker-data.com/tidycensus/">tidycensus</a></span><span class="op">)</span> 
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris">tigris</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span>

<span class="co"># nice to have packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span> <span class="co"># for the %&lt;&gt;% and %$% pipe</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/Hmisc/">Hmisc</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">epitools</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/">leaflet</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="cleaning-the-data" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Cleaning the Data<a class="anchor" aria-label="anchor" href="#cleaning-the-data"><i class="fas fa-link"></i></a>
</h2>
<div id="denominator-data" class="section level3" number="8.5.1">
<h3>
<span class="header-section-number">8.5.1</span> Denominator Data<a class="anchor" aria-label="anchor" href="#denominator-data"><i class="fas fa-link"></i></a>
</h3>
<p>Here we will use <code>tidycensus</code> to download relevant variables from the 2015-19 ACS dataset. The complete list of variables can be viewed online here: <a href="https://api.census.gov/data/2019/acs/acs5/variables.html" class="uri">https://api.census.gov/data/2019/acs/acs5/variables.html</a>. You will need a U.S. Census API key to download the data, which you can obtain from here: <a href="https://api.census.gov/data/key_signup.html" class="uri">https://api.census.gov/data/key_signup.html</a>. The key is for personal use here only, so it has been redacted here.</p>
<p>We will be looking at a range of different ABSMs, and we also require age-stratified populations by racialized group. You can browse the variables to identify which tables contain the variables you need.</p>
<div class="infobox dataWrangling">
<p>It can be helpful to identify patterns in the variable names to efficiently query the Census API. In the code below you will see an approach that does not require us to type out all the variable names. Can you think of more efficient ways to query the API?</p>
</div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># census_api_key("Your API KEY goes here")</span>

<span class="co"># get population sizes from ACS -------------------------------------------</span>

<span class="co">#Get a list of the variable names</span>
<span class="va">acs_vars</span> <span class="op">&lt;-</span> <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/load_variables.html">load_variables</a></span><span class="op">(</span><span class="fl">2019</span>, dataset <span class="op">=</span> <span class="st">'acs5'</span><span class="op">)</span>


<span class="co"># the racialized group and age-group stratified population estimates from ACS are</span>
<span class="co"># in the B01001 table.</span>
<span class="co"># </span>
<span class="co"># B01001_001 through _049 are the sex/gender overall population size estimates,</span>
<span class="co"># and B01001A through B01001I are the "race/ethnicity" specific tables.  For the</span>
<span class="co"># "race/ethnicity" specific tables the age-groups suffixes range from _001 to _031</span>
<span class="co"># </span>
<span class="co"># in the following three steps, we programmatically construct the population</span>
<span class="co"># size variables that we want to retrieve from the ACS since otherwise there are</span>
<span class="co"># a lot of them to type out.</span>
<span class="va">race_chars</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    white <span class="op">=</span> <span class="st">'H'</span>, <span class="co"># In the 2015-19 ACS data, a suffix of H indicates non-Hispanic White, but be careful because these suffixes may change from year to year!</span>
    black <span class="op">=</span> <span class="st">'B'</span>,
    hispanic_or_latino <span class="op">=</span> <span class="st">'I'</span>
  <span class="op">)</span>

<span class="co"># for each of H, B, and I, construct B01001*_001 through _031. If you look at the variable list at the link above, you will see that the variable names constructed below correspond to total and age-sex specific population estimates for each racialized/ethnic group.</span>
<span class="va">sex_race_age_vars</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'B01001'</span>, <span class="va">race_chars</span>, <span class="st">'_0'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">31</span><span class="op">)</span>,
         <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span>
           <span class="fl">1</span><span class="op">:</span><span class="fl">31</span>,
           width <span class="op">=</span> <span class="fl">2</span>,
           side <span class="op">=</span> <span class="st">'left'</span>,
           pad <span class="op">=</span> <span class="st">'0'</span>
         <span class="op">)</span><span class="op">)</span>

<span class="co"># this adds on the sex/gender overall population estimates (e.g.B01001_001 is the total male population)</span>
<span class="va">sex_race_age_vars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.</span>,
                         <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
                           <span class="st">'B01001_0'</span>,
                           <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span>
                             <span class="fl">1</span><span class="op">:</span><span class="fl">49</span>,
                             width <span class="op">=</span> <span class="fl">2</span>,
                             side <span class="op">=</span> <span class="st">'left'</span>,
                             pad <span class="op">=</span> <span class="st">'0'</span>
                           <span class="op">)</span>
                         <span class="op">)</span><span class="op">)</span>

<span class="co"># The API gives us data whose labels are all in one string, with information separated by '!!'. We split the label to make it more useful.</span>
<span class="va">acs_vars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">label</span>,
           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'estimate'</span>, <span class="st">'total'</span>, <span class="st">'gender'</span>, <span class="st">'age'</span>, <span class="st">'subgroup'</span><span class="op">)</span>,
           sep <span class="op">=</span> <span class="st">'!!'</span><span class="op">)</span>

<span class="co"># clean label values (remove unnecessary colon characters and leading/trailing spaces)</span>
<span class="va">acs_vars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span><span class="op">(</span>.vars <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">total</span>, <span class="va">gender</span>, <span class="va">age</span>, <span class="va">subgroup</span><span class="op">)</span>,
                        <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">":"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># select only what we need</span>
<span class="va">acs_vars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">total</span>, <span class="va">gender</span>, <span class="va">age</span>, <span class="va">concept</span><span class="op">)</span>

<span class="co"># Now that we have the variables names, we use it to get sex, racialized group (incl. hispanic or latino), and age stratified population</span>
<span class="co"># estimates</span>
<span class="va">popsizes</span> <span class="op">&lt;-</span>
  <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/get_acs.html">get_acs</a></span><span class="op">(</span>
    geography <span class="op">=</span> <span class="st">'zip code tabulation area'</span>,
    state <span class="op">=</span> <span class="st">'IL'</span>,
    year <span class="op">=</span> <span class="fl">2019</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># This obtains the geometry / shapes of each zip-code tabulation area (ZCTA)</span>
    variables <span class="op">=</span> <span class="va">sex_race_age_vars</span>,
    output <span class="op">=</span> <span class="st">'tidy'</span>,
    cache_table <span class="op">=</span> <span class="cn">T</span> <span class="co">#this will enable quicker loading if we load the data again in the future</span>
  <span class="op">)</span>

<span class="co"># join in our variable names</span>
<span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">acs_vars</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'variable'</span> <span class="op">=</span> <span class="st">'name'</span><span class="op">)</span><span class="op">)</span>

<span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># clean column names</span>
<span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">total</span><span class="op">)</span> <span class="co"># remove total column that only contains 'total'</span>

<span class="co"># While we set geometry = T so that we got the geometry data, we don't need this as we clean the data. It makes things slow, so we take out the geometry for use later</span>
<span class="va">zip_geometry</span> <span class="op">&lt;-</span> <span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># ggplot(zip_geometry) + geom_sf() # zip codes of illinois</span>

<span class="co"># remove geometry before data reshaping</span>
<span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="st">'sf'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">popsizes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"popsizes data has geometry, this can cause errors in the group_by and summarize steps using dplyr."</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># aggregate by sex/gender</span>
<span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">name</span>, <span class="va">age</span>, <span class="va">concept</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
  estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
  <span class="co"># here we're using the tidycensus::moe_sum function to create margin of error estimates for </span>
  <span class="co"># sums of population size estimates</span>
  moe <span class="op">=</span> <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/moe_sum.html">moe_sum</a></span><span class="op">(</span>moe <span class="op">=</span> <span class="va">moe</span>, estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>Since the Cook County Medical Examiner Case Archive data includes records on deaths where the decedents’ residential ZCTAs are inside as well as outside Cook County, Illinois, we want to restrict our dataset to deaths where their county of residence was in Cook County. An issue is that ZCTAs are not neatly nested within the county borders - often part of a ZCTA can lie outside the county.</p>
<div class="infobox dataWrangling">
<p>How would you work with this issue of ZCTAs crossing county borders? Here we calculated the percentage of an area in a ZCTA that also falls within the Cook County borders, and retained those with 90% overlap (an arbitrary threshold). Would you use a different threshold? We also had to deal with issues of parts of Lake Michigan (bordering Cook County’s east coast) being included in some shapefiles but not others.</p>
</div>
<div class="infobox interpretation">
<p>Note that the unit of geography for analysis is the US census-defined Zip Code Tabulation Area (ZCTA), which is related to but not identical with the US Postal Service ZIP Code (which is a unit of mail delivery, reflecting postal carrier routes, such that a given spatial area can encompass several ZIP Codes). To create ZCTAs, the US Census assigns each census block the most frequently occurring ZIP Code within the block. For technical information about ZCTAs, see: <a href="https://www.census.gov/programs-surveys/geography/guidance/geo-areas/zctas.html" class="uri">https://www.census.gov/programs-surveys/geography/guidance/geo-areas/zctas.html</a>. This means that ZCTAs and zip codes may not cover the same area exactly. A discussion of pitfalls to keep in mind when using ZCTAs linked to residential Zip Code can be found in this paper <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1447194/" class="uri">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1447194/</a> .</p>
</div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># identify relevant zip codes ---------------------------------------------</span>

<span class="co"># we originally downloaded the county shapefiles using tigris, but </span>
<span class="co"># we found that those contained water area we wanted to remove. </span>
<span class="co"># </span>
<span class="co"># we tried using the tigris::erase_water function but it took a very </span>
<span class="co"># long time to run for us, so we found that the alternative was easier</span>
<span class="co"># to implement:  downloading a county shapefile directly from the census </span>
<span class="co"># and using that one which came already with the water areas removed. </span>
<span class="co"># </span>
<span class="co"># We got our county shapefile for Cook county in what follows from here: </span>
<span class="co"># https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html </span>

<span class="co">########## Change to file path where the shape file is downloaded ###########</span>
<span class="va">counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">'./data/09-cook-county-covid/cb_2018_us_county_5m/cb_2018_us_county_5m.shp'</span><span class="op">)</span>

<span class="co"># get the map for cook county</span>
<span class="va">cook_county</span> <span class="op">&lt;-</span> <span class="va">counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
  <span class="co"># get the 5-digit FIPS or GEOID for Cook County programmatically by filtering</span>
  <span class="co"># the tigris::fips_codes dataframe, or if you happen to know it's 17031 </span>
  <span class="co"># you could code it explicitly instead</span>
  <span class="va">GEOID</span> <span class="op">==</span> <span class="fu">tigris</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tigris/man/fips_codes.html">fips_codes</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">county</span> <span class="op">==</span> <span class="st">'Cook County'</span>, <span class="va">state</span> <span class="op">==</span> <span class="st">'IL'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_code</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span>

<span class="co"># get cook county sf object from tigris that is water inclusive for filtering. Since the ZIP geometry can include bits of water, we want to use the Cook County boundaries that include Lake Michigan. Otherwise some coastal ZIP codes may have less than 90% overlap and get dropped.</span>
<span class="va">IL_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">'IL'</span><span class="op">)</span>
<span class="va">cook_county_incl_water</span> <span class="op">&lt;-</span> <span class="va">IL_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">COUNTYFP</span> <span class="op">==</span> <span class="op">{</span>
      <span class="fu">tigris</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tigris/man/fips_codes.html">fips_codes</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">'IL'</span>, <span class="va">county</span> <span class="op">==</span> <span class="st">'Cook County'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">county_code</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>

<span class="co"># Find the zip codes intersecting cook county. In the output of st_intersects, zips that intersect with cook county have length greater than 0. So here we keep Zips with any overlap</span>
<span class="va">zips_with_overlap</span> <span class="op">&lt;-</span> <span class="va">zip_geometry</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_intersects</a></span><span class="op">(</span><span class="va">zip_geometry</span>, <span class="va">cook_county_incl_water</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
                                    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,<span class="op">]</span>

<span class="co"># figure showing cook county and all ZCTAs intersecting it </span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cook_county_incl_water</span>, color <span class="op">=</span> <span class="st">'cadetblue'</span>, fill <span class="op">=</span> <span class="st">'cadetblue'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">zips_with_overlap</span>, color <span class="op">=</span> <span class="st">'orange'</span>, fill <span class="op">=</span> <span class="st">'white'</span>, alpha <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># interactive file </span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#Adds the basemap</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cook_county_incl_water</span>, weight <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#Adds the Cook county boundary</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">zips_with_overlap</span>, color <span class="op">=</span> <span class="st">'orange'</span>, weight <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="op">~</span><span class="va">geoid</span><span class="op">)</span> <span class="co"># Adds Zip boundaries</span>

<span class="co"># calculate each zip code total area</span>
<span class="va">zips_with_overlap</span><span class="op">$</span><span class="va">total_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">zips_with_overlap</span><span class="op">)</span>

<span class="co"># calculate the intersection of cook county and each zip code tabulation area</span>
<span class="va">zips_with_overlap_intersection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">zips_with_overlap</span>, <span class="va">cook_county_incl_water</span><span class="op">)</span> <span class="co">#this returns polygons where county and ZCTA intersect</span>
<span class="va">zips_with_overlap_intersection</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span><span class="op">)</span>

<span class="co"># calculate the area of each intersection</span>
<span class="va">zips_with_overlap_intersection</span><span class="op">$</span><span class="va">overlapping_area_w_cook_cty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">zips_with_overlap_intersection</span><span class="op">)</span>

<span class="co"># drop geometry so we can merge this back in</span>
<span class="va">zips_with_overlap_intersection</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># add in overlap calculation</span>
<span class="va">zips_with_overlap</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
  <span class="va">zips_with_overlap_intersection</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">overlapping_area_w_cook_cty</span><span class="op">)</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'geoid'</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># calculate the proportion of area for that zip code within cook county</span>
<span class="va">zips_with_overlap</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  prop_area_overlap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">overlapping_area_w_cook_cty</span> <span class="op">/</span> <span class="va">total_area</span><span class="op">)</span><span class="op">)</span>

<span class="co"># filter for zip codes with 90% land area inside cook county</span>
<span class="va">zips_with_over_90pct_overlap</span> <span class="op">&lt;-</span> <span class="va">zips_with_overlap</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prop_area_overlap</span> <span class="op">&gt;=</span> <span class="fl">.9</span><span class="op">)</span>

<span class="co"># Visualize Cook County and ZIPs with over 90 percent overlap</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cook_county</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Cook County"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span> <span class="co">#Plots Cook county boundary</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">zips_with_over_90pct_overlap</span>, <span class="co">#plots zip codes</span>
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Zip Code Tabulation Areas"</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fl">.5</span>,
    alpha <span class="op">=</span> <span class="fl">.6</span> <span class="co">#Sets transparency so we can see both layers</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Cook County"</span> <span class="op">=</span> <span class="st">"#E69F00"</span>, <span class="st">"Zip Code Tabulation Areas"</span> <span class="op">=</span> <span class="st">"#56B4E9"</span><span class="op">)</span> <span class="co">#manually set colors</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="co"># theme_bw() + </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'white'</span>, <span class="st">'grey95'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">88.3</span>, <span class="op">-</span><span class="fl">88.1</span>, <span class="op">-</span><span class="fl">87.9</span>, <span class="op">-</span><span class="fl">87.7</span>, <span class="op">-</span><span class="fl">87.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>   
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Cook County and Zip Code Tabulation Areas 90% Contained Within"</span><span class="op">)</span>

<span class="co"># save the plot</span>
<span class="co"># ggsave(here("images/09-cook-county-covid/cook_county_and_zip_codes.png"), width = 10, height = 6)</span></code></pre></div>
<p>Now that we have obtained the ZCTAs that we will keep in the study, we can now focus on these to prepare demographic and denominator data.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># group population sizes together by age groups and racialized group and zip code</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op">&lt;-</span>
  <span class="va">popsizes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">concept</span> <span class="op">!=</span> <span class="st">'SEX BY AGE'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># filter for overall population</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geoid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">zips_with_over_90pct_overlap</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span> <span class="co">#Filter to keep only the zips selected above</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">zips_with_over_90pct_overlap</span>, <span class="va">.</span><span class="op">)</span> <span class="co">#join with the zip dataframe to add the geometry column</span>

<span class="co"># Change names of the Census racialized groups</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  race_ethnicity <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">concept</span> <span class="op">==</span>  <span class="st">"SEX BY AGE (BLACK OR AFRICAN AMERICAN ALONE)"</span> <span class="op">~</span> <span class="st">"Black, Hispanic or non-Hispanic"</span>,
    <span class="va">concept</span> <span class="op">==</span>  <span class="st">"SEX BY AGE (HISPANIC OR LATINO)"</span> <span class="op">~</span> <span class="st">"Hispanic"</span>,
    <span class="va">concept</span> <span class="op">==</span>  <span class="st">"SEX BY AGE (WHITE ALONE, NOT HISPANIC OR LATINO)"</span> <span class="op">~</span> <span class="st">"White, non-Hispanic"</span>
  <span class="op">)</span><span class="op">)</span>


<span class="co"># remove totals (across age groups) observations</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">)</span>

<span class="co"># aggregate into larger age groups</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  age_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
    <span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"Under 5 years"</span>,
      <span class="st">"5 to 9 years"</span>,
      <span class="st">"10 to 14 years"</span>,
      <span class="st">"15 to 17 years"</span>,
      <span class="st">"18 and 19 years"</span>,
      <span class="st">"20 to 24 years"</span>
    <span class="op">)</span> <span class="op">~</span> <span class="st">"Under 25"</span>,
    <span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"25 to 29 years"</span>,
      <span class="st">"30 to 34 years"</span>
    <span class="op">)</span> <span class="op">~</span> <span class="st">"25 to 34 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"35 to 44 years"</span> <span class="op">~</span> <span class="st">"35 to 44 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"45 to 54 years"</span> <span class="op">~</span> <span class="st">"45 to 54 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"55 to 64 years"</span> <span class="op">~</span> <span class="st">"55 to 64 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"65 to 74 years"</span> <span class="op">~</span> <span class="st">"65 to 74 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"75 to 84 years"</span> <span class="op">~</span> <span class="st">"75 to 84 years"</span>,
    <span class="va">age</span> <span class="op">==</span> <span class="st">"85 years and over"</span> <span class="op">~</span> <span class="st">"85 years and over"</span>
  <span class="op">)</span><span class="op">)</span>

<span class="co"># sum age group population sizes by racialized group</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">age_group</span>, <span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>
    estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">estimate</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,
    moe <span class="op">=</span> <span class="fu"><a href="https://walker-data.com/tidycensus/reference/moe_sum.html">moe_sum</a></span><span class="op">(</span><span class="va">moe</span>, <span class="va">estimate</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># check how large the population sizes are by racialized group and age</span>
<span class="co"># in each ZCTA</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span> <span class="co">#estimate is the column name for the population size</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">~</span><span class="va">age_group</span><span class="op">)</span> <span class="op">+</span> <span class="co">#creates grid of individual plots for each combination of racialized group and age group</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="co">#x axis in log scale since distribution of population counts is skewed</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Population Estimate"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Population Sizes by Racialized Group and Age Group in ZCTAs"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="co">#rotate x-axis labels</span>
  

<span class="co"># ggsave(here("images/09-cook-county-covid/population_count_histogram.png"), height = 8, width = 10)</span>

<span class="co"># check how many have estimates less than 10</span>
<span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">estimate</span> <span class="op">&lt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/cook_county_and_zip_codes.png" width="100%"></div>
</div>
<div id="case-data" class="section level3" number="8.5.2">
<h3>
<span class="header-section-number">8.5.2</span> Case Data<a class="anchor" aria-label="anchor" href="#case-data"><i class="fas fa-link"></i></a>
</h3>
<p>Now we’re ready to load the case data, and add the population size estimates for each racialized group (White non-Hispanic, Black non-Hispanic, and Hispanic) and age-group by ZIP code.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read in your data. This has been donwloaded from the Cook County Medical Examiner's office website, as mentioned above. https://datacatalog.cookcountyil.gov/Public-Safety/Medical-Examiner-Case-Archive-COVID-19-Related-Dea/3trz-enys</span>

<span class="va">cook_county_deaths</span> <span class="op">&lt;-</span> 
  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"./data/09-cook-county-covid/Medical_Examiner_Case_Archive_-_COVID-19_Related_Deaths.csv"</span><span class="op">)</span>

<span class="co"># merge racialized group and age-group specific denominators ----------------</span>

<span class="co"># use janitor::clean_names to standardize column name syntax into snake_case</span>
<span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># check distribution of deaths if needed</span>
<span class="co">#ggplot(cook_county_deaths, aes(x = age)) + geom_bar()</span>
<span class="co">#ggplot(cook_county_deaths, aes(x = race)) + geom_bar() </span>
<span class="co">#ggplot(cook_county_deaths, aes(x = latino)) + geom_bar() + facet_wrap(~race)</span>
<span class="co">#ggplot(cook_county_deaths, aes(x = latino)) + geom_bar()</span>

<span class="co"># code racialized groups into the following: </span>
<span class="co">#  Black (Hispanic or non-Hispanic)</span>
<span class="co">#  Hispanic and non-Hispanic</span>
<span class="co">#  White non-Hispanic</span>
<span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    black <span class="op">=</span> <span class="va">race</span> <span class="op">==</span> <span class="st">'Black'</span>,
    white_nh <span class="op">=</span> <span class="op">(</span><span class="op">!</span> <span class="va">latino</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">race</span> <span class="op">==</span> <span class="st">'White'</span>,
    hispanic <span class="op">=</span> <span class="va">latino</span>
  <span class="op">)</span>

<span class="co"># we restrict our time-period to during March 2020 to March 2022 -- noting the </span>
<span class="co"># information on the dataset stories web page: </span>
<span class="co"># </span>
<span class="co">#  https://datacatalog.cookcountyil.gov/stories/s/ttk4-trbu</span>
<span class="co"># </span>
<span class="co">#  Effective April 1, 2022, the Cook County Medical Examiner’s Office no longer</span>
<span class="co">#  takes jurisdiction over hospital, nursing home or hospice COVID-19 deaths</span>
<span class="co">#  unless there is another factor that falls within the Office’s jurisdiction.</span>
<span class="co"># </span>
<span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
  <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hms</a></span><span class="op">(</span><span class="va">date_of_death</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">(</span><span class="st">"03/01/2020"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="co">#convert date in character format to a date format (POSIXct). This allows evaluation of conditions such as date greater than x, etc.</span>
    <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">mdy_hms</a></span><span class="op">(</span><span class="va">date_of_death</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">(</span><span class="st">"04/01/2022"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Truncate Zip Codes to 5 Characters</span>
<span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>residence_zip <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">residence_zip</span>, <span class="st">"^[0-9]{5}"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Categorize Age Group</span>
<span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    age_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
      <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">24</span> <span class="op">~</span> <span class="st">"Under 25"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">25</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">35</span> <span class="op">~</span> <span class="st">"25 to 34 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">35</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">44</span> <span class="op">~</span> <span class="st">"35 to 44 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">45</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">54</span> <span class="op">~</span> <span class="st">"45 to 54 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">55</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">64</span> <span class="op">~</span> <span class="st">"55 to 64 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">74</span> <span class="op">~</span> <span class="st">"65 to 74 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">75</span> <span class="op">&amp;</span> <span class="va">age</span> <span class="op">&lt;=</span> <span class="fl">84</span> <span class="op">~</span> <span class="st">"75 to 84 years"</span>,
      <span class="va">age</span> <span class="op">&gt;=</span> <span class="fl">85</span> <span class="op">~</span> <span class="st">"85 years and over"</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="co">#Convert to factor so that when plotting age groups are plotted in order</span>
<span class="va">cook_county_deaths</span><span class="op">$</span><span class="va">age_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
   <span class="st">"Under 25"</span>,
   <span class="st">"25 to 34 years"</span>,
   <span class="st">"30 to 34 years"</span>,
   <span class="st">"35 to 44 years"</span>,
   <span class="st">"45 to 54 years"</span>,
   <span class="st">"55 to 64 years"</span>,
   <span class="st">"65 to 74 years"</span>,
   <span class="st">"75 to 84 years"</span>,
   <span class="st">"85 years and over"</span><span class="op">)</span>
  <span class="op">)</span> 

<span class="co"># separate out deaths into the racialized group categories we're interested in </span>
<span class="co"># </span>
<span class="co"># note that these do have overlap: since the ACS variables do not include </span>
<span class="co"># age tables for the Black non-Hispanic group, we are using the Black </span>
<span class="co"># Hispanic or non-Hispanic population by age tables, and so there is overlap</span>
<span class="co"># between them and the Hispanic group counts.</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    black <span class="op">=</span> <span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">black</span><span class="op">)</span>,
    hispanic <span class="op">=</span> <span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hispanic</span><span class="op">)</span>,
    white_nh <span class="op">=</span> <span class="va">cook_county_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">white_nh</span><span class="op">)</span>
  <span class="op">)</span> 

<span class="co"># Assign labels for the racialized groups </span>
<span class="va">race_ethnicity_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"Black, Hispanic or non-Hispanic"</span>,
  <span class="st">"Hispanic"</span>,
  <span class="st">"White, non-Hispanic"</span>
<span class="op">)</span>

<span class="co"># for each racialized group, tabulate the number of deaths by age group and </span>
<span class="co"># residence zip code. </span>
<span class="co"># </span>
<span class="co"># here, purrr::map is applying a function which does that tabulation to each of</span>
<span class="co"># the data frames in the deaths_by_race_ethnicity_group list</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op">&lt;-</span> 
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">deaths_by_race_ethnicity_group</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">residence_zip</span>, <span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'deaths'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_ethnicity <span class="op">=</span> <span class="va">race_ethnicity_groups</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="co"># bind the tables for each of the racialized groups together</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># check how many of the deaths proportionally were NA</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">deaths_by_race_ethnicity_group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_group</span>, y <span class="op">=</span> <span class="va">deaths</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Count of Deaths"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co"># remove missing age, missing deaths in racialized groups</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span><span class="op">)</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">)</span>

<span class="co"># check distribution of deaths by age group</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span> 

<span class="co"># check distribution of deaths by racial/ethnic group</span>
<span class="va">deaths_by_race_ethnicity_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="op">)</span> 

<span class="co"># merge the denominators and deaths together</span>
<span class="va">df</span> <span class="op">&lt;-</span>
  <span class="va">zips_with_population_estimates_by_race_ethnicity_and_age</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
  <span class="va">deaths_by_race_ethnicity_group</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'geoid'</span> <span class="op">=</span> <span class="st">'residence_zip'</span>, <span class="st">'age_group'</span> <span class="op">=</span> <span class="st">'age_group'</span>, <span class="st">'race_ethnicity'</span> <span class="op">=</span> <span class="st">'race_ethnicity'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># make age_group a factor variable</span>
<span class="va">df</span><span class="op">$</span><span class="va">age_group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">'Under 25'</span>,
    <span class="st">'25 to 34 years'</span>,
    <span class="st">'35 to 44 years'</span>,
    <span class="st">'45 to 54 years'</span>,
    <span class="st">'55 to 64 years'</span>,
    <span class="st">'65 to 74 years'</span>,
    <span class="st">'75 to 84 years'</span>,
    <span class="st">'85 years and over'</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># add person-time</span>
<span class="va">observation_time_in_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">(</span><span class="st">"04-01-2022"</span><span class="op">)</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">(</span><span class="st">"03-01-2020"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">365</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>person_time <span class="op">=</span> <span class="va">estimate</span> <span class="op">*</span> <span class="va">observation_time_in_years</span><span class="op">)</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">deaths</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mortality_per100k_py <span class="op">=</span> <span class="va">deaths</span> <span class="op">/</span> <span class="va">person_time</span> <span class="op">*</span> <span class="fl">1e5</span><span class="op">)</span>

<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span>, <span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_group</span>, y <span class="op">=</span> <span class="va">deaths</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Age Group"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Count of Deaths"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Age Distribution of COVID-19 Deaths in Cook County, IL"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/age_distribution_deaths.png"), width = 8, height = 6)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/age_distribution_deaths.png" width="100%"></div>
<p>We can now add ABSMs that we are interested in to the data. We’ll add the Index of Concentration at the Extremes for Racialized Economic Segregation, the proportion of the population under the poverty line, and the median income in each ZCTA.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add area based socioeconomic measures  ----------------------------------</span>

<span class="co"># get zip code rates for</span>
<span class="co">#   - poverty</span>
<span class="co">#   - ICEraceinc</span>
<span class="co">#   - median income</span>

<span class="co"># We create a data dictionary for ABSMS. The first column indicates the total variable code, the second the variable name, and the third the description.</span>
<span class="va">absms_dictionary</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
  <span class="op">~</span><span class="va">var</span>, <span class="op">~</span><span class="va">varname</span>, <span class="op">~</span><span class="va">description</span>,
  <span class="co"># total population</span>
  <span class="st">"B01001_001"</span>,  <span class="st">"total_popsize"</span>, <span class="st">"total population estimate"</span>, 
  
  <span class="co"># racial composition </span>
  <span class="st">'B01003_001'</span>,  <span class="st">"race_ethnicity_total"</span>, <span class="st">"race_ethnicity_total"</span>,
  
  <span class="co"># ICEraceinc</span>
  <span class="st">"B19001_001"</span>,  <span class="st">'hhinc_total'</span>,   <span class="st">"total population for household income estimates"</span>,
  <span class="st">"B19001A_002"</span>, <span class="st">'hhinc_w_1'</span>,     <span class="st">"white n.h. pop with household income &lt;$10k"</span>,
  <span class="st">"B19001A_003"</span>, <span class="st">'hhinc_w_2'</span>,     <span class="st">"white n.h. pop with household income $10k-14 999k"</span>,
  <span class="st">"B19001A_004"</span>, <span class="st">'hhinc_w_3'</span>,     <span class="st">"white n.h. pop with household income $15k-19 999k"</span>,
  <span class="st">"B19001A_005"</span>, <span class="st">'hhinc_w_4'</span>,     <span class="st">"white n.h. pop with household income $20k-24 999k"</span>,
  <span class="st">"B19001A_014"</span>, <span class="st">'hhinc_w_5'</span>,     <span class="st">"white n.h. pop with household income $100 000 to $124 999"</span>,
  <span class="st">"B19001A_015"</span>, <span class="st">'hhinc_w_6'</span>,     <span class="st">"white n.h. pop with household income $125k-149 999k"</span>,
  <span class="st">"B19001A_016"</span>, <span class="st">'hhinc_w_7'</span>,     <span class="st">"white n.h. pop with household income $150k-199 999k"</span>,
  <span class="st">"B19001A_017"</span>, <span class="st">'hhinc_w_8'</span>,     <span class="st">"white n.h. pop with household income $196k+"</span>,
  <span class="st">"B19001_002"</span>,  <span class="st">'hhinc_total_1'</span>, <span class="st">"total pop with household income &lt;$10k"</span>,
  <span class="st">"B19001_003"</span>,  <span class="st">'hhinc_total_2'</span>, <span class="st">"total pop with household income $10k-14 999k"</span>,
  <span class="st">"B19001_004"</span>,  <span class="st">'hhinc_total_3'</span>, <span class="st">"total pop with household income $15k-19 999k"</span>,
  <span class="st">"B19001_005"</span>,  <span class="st">'hhinc_total_4'</span>, <span class="st">"total pop with household income $20k-24 999k"</span>,

  <span class="co"># poverty</span>
  <span class="st">"B05010_002"</span>,  <span class="st">'in_poverty'</span>,    <span class="st">"population with household income &lt; poverty line"</span>,
  <span class="st">"B05010_001"</span>,  <span class="st">'total_pop_for_poverty_estimates'</span>,  <span class="st">"total population for poverty estimates"</span>,

  <span class="co"># median income</span>
  <span class="st">"B06011_001"</span>,  <span class="st">'median_income'</span>,  <span class="st">"median income estimate for total population"</span>,
  
  <span class="co"># crowded housing</span>
  <span class="st">"B25014_005"</span>,  <span class="st">'owner_occupied_crowding1'</span>, <span class="st">'owner occupied, 1 to 1.5 per room'</span>,
  <span class="st">"B25014_006"</span>,  <span class="st">'owner_occupied_crowding2'</span>, <span class="st">'owner occupied, 1.51 to 2 per room'</span>,
  <span class="st">"B25014_007"</span>,  <span class="st">'owner_occupied_crowding3'</span>, <span class="st">'owner occupied, 2.01 or more per room'</span>,
  <span class="st">"B25014_011"</span>,  <span class="st">'renter_occupied_crowding1'</span>, <span class="st">'owner occupied, 1 to 1.5 per room'</span>,
  <span class="st">"B25014_012"</span>,  <span class="st">'renter_occupied_crowding2'</span>, <span class="st">'owner occupied, 1.51 to 2 per room'</span>,
  <span class="st">"B25014_013"</span>,  <span class="st">'renter_occupied_crowding3'</span>, <span class="st">'owner occupied, 2.01 or more per room'</span>,
  <span class="st">"B25014_001"</span>,  <span class="st">'crowding_total'</span>,            <span class="st">'total for crowding (occupants per room)'</span>,
  
  <span class="st">"B01001I_001"</span>,  <span class="st">'total_hispanic'</span>,           <span class="st">'total hispanic population estimate'</span>,
  <span class="st">"B01001B_001"</span>,  <span class="st">'total_black'</span>,              <span class="st">'total black, hispanic or non-hispanic estimate'</span>,
  <span class="st">"B01001H_001"</span>,  <span class="st">'total_white_nh'</span>,           <span class="st">'total white, non-hispanic population estimate'</span>
<span class="op">)</span>

<span class="co"># We create a function which takes as a argument a vector of zip codes, and queries the Census API using those to obtain our ABSM variables for those ZCTAs, and then calculates the ABSMs of interest.</span>

<span class="va">get_absms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">zip_codes</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">absms</span> <span class="op">&lt;-</span> <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/get_acs.html">get_acs</a></span><span class="op">(</span>
    year <span class="op">=</span> <span class="fl">2019</span>,
    geography <span class="op">=</span> <span class="st">'zcta'</span>,
    state <span class="op">=</span> <span class="st">'IL'</span>,
    zcta <span class="op">=</span> <span class="va">zip_codes</span>,
    variables <span class="op">=</span> <span class="va">absms_dictionary</span><span class="op">$</span><span class="va">var</span>, <span class="co">#Get the variables indicated in the data dictionary.</span>
    geometry <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># We already have the geometry so we don't need that.</span>
  <span class="op">)</span>

  <span class="co"># pivot wider so that each row corresponds to a ZCTA</span>
  <span class="va">absms</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">moe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">variable</span>, values_from <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>
<span class="co"># Change the new column names to reflect variables names from the dictionary</span>
  <span class="va">rename_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">absms_dictionary</span><span class="op">$</span><span class="va">var</span>, <span class="va">absms_dictionary</span><span class="op">$</span><span class="va">varname</span><span class="op">)</span>
  <span class="va">absms</span> <span class="op">&lt;-</span> <span class="va">absms</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">rename_vars</span><span class="op">)</span>

  <span class="va">absms</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      <span class="co"># we calculate the people of color low income counts as the overall</span>
      <span class="co"># low income counts minus the white non-hispanic low income counts</span>
      people_of_color_low_income <span class="op">=</span>
        <span class="op">(</span><span class="va">hhinc_total_1</span> <span class="op">+</span> <span class="va">hhinc_total_2</span> <span class="op">+</span> <span class="va">hhinc_total_3</span> <span class="op">+</span> <span class="va">hhinc_total_4</span><span class="op">)</span> <span class="op">-</span>
        <span class="op">(</span><span class="va">hhinc_w_1</span> <span class="op">+</span> <span class="va">hhinc_w_2</span> <span class="op">+</span> <span class="va">hhinc_w_3</span> <span class="op">+</span> <span class="va">hhinc_w_4</span><span class="op">)</span>,
      <span class="co"># sum up the white non-hispanic high income counts</span>
      white_non_hispanic_high_income <span class="op">=</span>
        <span class="op">(</span><span class="va">hhinc_w_5</span> <span class="op">+</span> <span class="va">hhinc_w_6</span> <span class="op">+</span> <span class="va">hhinc_w_7</span> <span class="op">+</span> <span class="va">hhinc_w_8</span><span class="op">)</span>,
      <span class="co"># calculate the index of concentration at the extremes for racialized</span>
      <span class="co"># economic segregation (high income white non-hispanic vs. low income</span>
      <span class="co"># people of color)</span>
      ICEraceinc <span class="op">=</span>
        <span class="op">(</span><span class="va">white_non_hispanic_high_income</span> <span class="op">-</span> <span class="va">people_of_color_low_income</span><span class="op">)</span> <span class="op">/</span>
        <span class="va">hhinc_total</span>,

      prop_in_poverty <span class="op">=</span> <span class="va">in_poverty</span> <span class="op">/</span> <span class="va">total_pop_for_poverty_estimates</span>,
      
      crowding <span class="op">=</span> <span class="op">(</span><span class="va">owner_occupied_crowding1</span> <span class="op">+</span> <span class="va">owner_occupied_crowding2</span> <span class="op">+</span> <span class="va">owner_occupied_crowding3</span> <span class="op">+</span>
        <span class="va">renter_occupied_crowding1</span> <span class="op">+</span> <span class="va">renter_occupied_crowding2</span> <span class="op">+</span> <span class="va">renter_occupied_crowding3</span><span class="op">)</span> <span class="op">/</span> <span class="va">crowding_total</span>,
      
      prop_black <span class="op">=</span> <span class="va">total_black</span> <span class="op">/</span> <span class="va">total_popsize</span>,
      prop_hispanic <span class="op">=</span> <span class="va">total_hispanic</span> <span class="op">/</span> <span class="va">total_popsize</span>,
      prop_white_nh <span class="op">=</span> <span class="va">total_white_nh</span> <span class="op">/</span> <span class="va">total_popsize</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">GEOID</span>, <span class="va">ICEraceinc</span>, <span class="va">prop_in_poverty</span>, <span class="va">median_income</span>, <span class="va">crowding</span>, <span class="va">prop_black</span>, <span class="va">prop_hispanic</span>, <span class="va">prop_white_nh</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">absms</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">absms</span> <span class="op">&lt;-</span> <span class="fu">get_absms</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span>

<span class="co"># merge in absm data to outcome data</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">absms</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'geoid'</span> <span class="op">=</span> <span class="st">'GEOID'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># get cutpoints for ICEraceinc in illinois --------------------------------</span>

<span class="co"># we're doing this because we want our cutpoints to be in reference to the </span>
<span class="co"># state distribution for the ICEraceinc variable;  other cutpoints can be used, </span>
<span class="co"># but it's important to be transparent about what cutpoints are used and consider</span>
<span class="co"># how the choice of cutpoints may affect the analysis.</span>
<span class="co"># </span>
<span class="va">illinois_absms</span> <span class="op">&lt;-</span>
  <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/get_acs.html">get_acs</a></span><span class="op">(</span>
    year <span class="op">=</span> <span class="fl">2019</span>,
    geography <span class="op">=</span> <span class="st">'zcta'</span>,
    state <span class="op">=</span> <span class="st">'IL'</span>, <span class="co"># Getting for all of IL</span>
    variables <span class="op">=</span> <span class="va">absms_dictionary</span><span class="op">$</span><span class="va">var</span>,
    geometry <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">moe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">variable</span>, values_from <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>

<span class="va">rename_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">absms_dictionary</span><span class="op">$</span><span class="va">var</span>, <span class="va">absms_dictionary</span><span class="op">$</span><span class="va">varname</span><span class="op">)</span>
<span class="va">illinois_absms</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">rename_vars</span><span class="op">)</span>

<span class="va">illinois_absms</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    <span class="co"># we calculate the people of color low income counts as the overall</span>
    <span class="co"># low income counts minus the white non-hispanic low income counts</span>
    people_of_color_low_income <span class="op">=</span>
      <span class="op">(</span><span class="va">hhinc_total_1</span> <span class="op">+</span> <span class="va">hhinc_total_2</span> <span class="op">+</span> <span class="va">hhinc_total_3</span> <span class="op">+</span> <span class="va">hhinc_total_4</span><span class="op">)</span> <span class="op">-</span>
      <span class="op">(</span><span class="va">hhinc_w_1</span> <span class="op">+</span> <span class="va">hhinc_w_2</span> <span class="op">+</span> <span class="va">hhinc_w_3</span> <span class="op">+</span> <span class="va">hhinc_w_4</span><span class="op">)</span>,
    <span class="co"># sum up the white non-hispanic high income counts</span>
    white_non_hispanic_high_income <span class="op">=</span>
      <span class="op">(</span><span class="va">hhinc_w_5</span> <span class="op">+</span> <span class="va">hhinc_w_6</span> <span class="op">+</span> <span class="va">hhinc_w_7</span> <span class="op">+</span> <span class="va">hhinc_w_8</span><span class="op">)</span>,
    <span class="co"># calculate the index of concentration at the extremes for racialized</span>
    <span class="co"># economic segregation (high income white non-hispanic vs. low income</span>
    <span class="co"># people of color)</span>
    ICEraceinc <span class="op">=</span>
      <span class="op">(</span><span class="va">white_non_hispanic_high_income</span> <span class="op">-</span> <span class="va">people_of_color_low_income</span><span class="op">)</span> <span class="op">/</span>
      <span class="va">hhinc_total</span>,
    
    <span class="co"># we don't need poverty here since we're going to use pre-specified cutpoints</span>
    <span class="co"># of 0-5%, 5-10%, 10-20% and 20%+ </span>
    
    <span class="co"># calculate crowding</span>
    crowding <span class="op">=</span> <span class="op">(</span><span class="va">owner_occupied_crowding1</span> <span class="op">+</span> <span class="va">owner_occupied_crowding2</span> <span class="op">+</span> <span class="va">owner_occupied_crowding3</span> <span class="op">+</span>
        <span class="va">renter_occupied_crowding1</span> <span class="op">+</span> <span class="va">renter_occupied_crowding2</span> <span class="op">+</span> <span class="va">renter_occupied_crowding3</span><span class="op">)</span> <span class="op">/</span> <span class="va">crowding_total</span>,
    
    <span class="co"># racial/ethnic composition variables</span>
    prop_black <span class="op">=</span> <span class="va">total_black</span> <span class="op">/</span> <span class="va">total_popsize</span>,
    prop_hispanic <span class="op">=</span> <span class="va">total_hispanic</span> <span class="op">/</span> <span class="va">total_popsize</span>,
    prop_white_nh <span class="op">=</span> <span class="va">total_white_nh</span> <span class="op">/</span> <span class="va">total_popsize</span>
  <span class="op">)</span> 

<span class="co"># Using the state-wide distribution of ABSMs at the ZCTA-level, we select cutpoints for quantiles.</span>
<span class="va">illinois_ICEraceinc_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">ICEraceinc</span>, <span class="co">#Weighted quantile of ICE</span>
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>, <span class="co">#Weights proportional to population size</span>
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>, <span class="co"># Cutpoints at 0, 0.2, 0.4, 0.8, 1</span>
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">illinois_ICEraceinc_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">ICEraceinc</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">illinois_median_income_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">median_income</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>


<span class="va">illinois_crowding_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">crowding</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">illinois_prop_hispanic_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">prop_hispanic</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">illinois_prop_black_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">prop_black</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">illinois_prop_white_nh_cutpoints</span> <span class="op">&lt;-</span>
  <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">illinois_absms</span><span class="op">$</span><span class="va">prop_white_nh</span>,
                      <span class="va">illinois_absms</span><span class="op">$</span><span class="va">total_popsize</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">.2</span><span class="op">)</span>,
                      na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co"># create cutpoint-leveled version of key ABSM variables</span>
<span class="va">df</span><span class="op">$</span><span class="va">ICEraceinc_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">ICEraceinc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_ICEraceinc_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">median_income_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">median_income</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_median_income_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">prop_in_poverty_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">prop_in_poverty</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>,  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.05</span>, <span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">1</span><span class="op">)</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">crowding_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">crowding</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_crowding_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">prop_black_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">prop_black</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_prop_black_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">prop_hispanic_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">prop_hispanic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_prop_hispanic_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">prop_white_nh_cut</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">prop_white_nh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/cut.html">cut</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">illinois_prop_white_nh_cutpoints</span>, include.lowest<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>We have added discretized (cut, i.e. categorical) versions of the different ABSMs. This is because this helps to allow the model flexibility to fit nonlinear responses with increasing levels in these covariates. Alternative approaches could involve fitting the models with smoothing splines on these variables instead, but we aren’t showing that here today. We used Illinois-wide distribution of ABSMs at the ZCTA level to create quantiles for all variables except poverty. For poverty, we use pre-specified cutpoints.</p>
<div class="infobox interpretation">
<p>Here we set the cutpoints for the continuous ABSMs based on the state-wide distribution of ZCTAs. How might this affect our interpretation? How might your research question and context affect how you decide what the ABSM cutpoints are?</p>
</div>
<div class="infobox communication">
<p>How might the selection of cutpoints affect your visualizations? How might your cutpoints change depending on what you want to communicate through the map?</p>
</div>
<p>We have a few remaining necessary cleaning steps to perform before we’re ready to model these data.</p>
<p>We have to make sure our factor variables have appropriate reference levels set. Typically we set the reference level as the most privileged group so that we can frame the results as “the _____ group has X times the mortality rate of the reference group.”</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># prepare data for modeling  ----------------------------------------------</span>

<span class="co"># remove infinite or NA mortality rates since they will cause errors in trying</span>
<span class="co"># to fit the models</span>
<span class="va">df_prepped</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">mortality_per100k_py</span><span class="op">)</span> <span class="op">&amp;</span>
    <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mortality_per100k_py</span><span class="op">)</span><span class="op">)</span>

<span class="co"># ungroup</span>
<span class="va">df_prepped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># make the most privileged the reference category</span>
<span class="va">df_prepped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  race_ethnicity <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span>, <span class="st">"White, non-Hispanic"</span><span class="op">)</span>,
  age_group <span class="op">=</span> <span class="va">age_group</span>,
  ICEraceinc_cut <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">ICEraceinc_cut</span><span class="op">)</span>,
  median_income_cut <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">median_income_cut</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># rename the estimate variable to 'population_estimate' to be more clear</span>
<span class="va">df_prepped</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>population_estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>

<span class="co"># save data </span>
<span class="co"># saveRDS(df_prepped, here("data/09-cook-county-covid/cook_county_mortality_cleaned.rds"))</span></code></pre></div>
</div>
</div>
<div id="visualizing-your-data-1" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Visualizing Your Data<a class="anchor" aria-label="anchor" href="#visualizing-your-data-1"><i class="fas fa-link"></i></a>
</h2>
<p>If you want to start by using the clean dataset you can start from this point on. Now that we have a clean dataset, we can create some exploratory visualizations. In the code chunk above we do some exploratory visualizations of the data. The first series of maps show the crude mortality rates by ZCTA, racialized group and Age Group. <strong>To see a larger version of this or any other image on the online version of the book right click and select open image in new tab.</strong></p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#change this to point to where your downloaded file is</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./data/09-cook-county-covid/cook_county_mortality_cleaned.rds"</span><span class="op">)</span> 

<span class="co">#Read in the county boundary shapefile to plot maps</span>
<span class="va">counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">'./data/09-cook-county-covid/cb_2018_us_county_5m/cb_2018_us_county_5m.shp'</span><span class="op">)</span> 

<span class="co"># get the map for cook county</span>
<span class="va">cook_county</span> <span class="op">&lt;-</span> <span class="va">counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
  <span class="co"># get the 5-digit FIPS or GEOID for Cook County programmatically by filtering</span>
  <span class="co"># the tigris::fips_codes dataframe, or if you happen to know it's 17031 </span>
  <span class="co"># you could code it explicitly instead</span>
  <span class="va">GEOID</span> <span class="op">==</span> <span class="fu">tigris</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tigris/man/fips_codes.html">fips_codes</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">county</span> <span class="op">==</span> <span class="st">'Cook County'</span>, <span class="va">state</span> <span class="op">==</span> <span class="st">'IL'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/exposition.html">%$%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">state_code</span>, <span class="va">county_code</span><span class="op">)</span><span class="op">)</span>

<span class="co"># let's start by mapping the crude mortality rates in each racialized group and </span>
<span class="co"># age strata</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">deaths</span><span class="op">)</span><span class="op">)</span> <span class="co"># Convert missing cells to 0</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mortality_per100k_py <span class="op">=</span> <span class="va">deaths</span> <span class="op">/</span> <span class="va">person_time</span> <span class="op">*</span> <span class="fl">1e5</span><span class="op">)</span> <span class="co"># Calculate mortality rate per 100,000 person years</span>

<span class="co"># plot raw mortality rates</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mortality_per100k_py</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cook_county</span>, fill <span class="op">=</span> <span class="st">'dimgrey'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">~</span><span class="va">age_group</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Create maps of mortality rates by age-group and racialized/ethnic groups</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'Reds'</span>, 
                       trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, <span class="co">#log transform since distribution is skewed</span>
                       direction <span class="op">=</span> <span class="fl">1</span>, <span class="co">#Higher is darker</span>
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span>, 
                       na.value <span class="op">=</span> <span class="st">'dimgrey'</span>, <span class="co">#NAs as grey</span>
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">80000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">88.1</span>, <span class="op">-</span><span class="fl">87.7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>   
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>, 
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'COVID-19 Mortality per 100,000 person years'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Crude COVID-19 Mortality Rates by ZCTA, Racialized Group and Age Group"</span>,
          subtitle <span class="op">=</span> <span class="st">"March 2020 - March 2022"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/raw_rates_by_zcta.png"), width = 14, height = 8)</span>

<span class="co"># plot population sizes</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">population_estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cook_county</span>, fill <span class="op">=</span> <span class="st">'dimgrey'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">~</span><span class="va">age_group</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'Greens'</span>, trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, direction <span class="op">=</span> <span class="fl">1</span>, 
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="st">'dimgrey'</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, 
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">10000</span>, <span class="fl">30000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">88.1</span>, <span class="op">-</span><span class="fl">87.7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>   
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>, 
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Population Estimate'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Population Size by ZCTA, Racialized Group and Age Group"</span>,
          subtitle <span class="op">=</span> <span class="st">"Data from ACS 2015-2019"</span><span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/population_size_by_zcta.png", width = 14, height = 8)</span>

<span class="co">#Plot mortality rates</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mortality_per100k_py</span>, fill <span class="op">=</span> <span class="va">race_ethnicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.8</span>, position <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op">~</span> <span class="va">age_group</span>,
             scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>
    trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span>,
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">5e4</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mortality Rate per 100,000 Person Years"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Racialized Groups'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Histogram of Mortality Rates by ZCTA, Age Group and Racialized Group"</span>,
          subtitle <span class="op">=</span> <span class="st">"March 2020 - March 2022"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/raw_rates_histogram.png"), width = 16, height = 8)</span>

<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">population_estimate</span>, 
        y <span class="op">=</span> <span class="va">mortality_per100k_py</span>, 
        color <span class="op">=</span> <span class="va">race_ethnicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op">~</span> <span class="va">age_group</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>
    trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span>,
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">5e4</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>
    trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">log_trans</a></span><span class="op">(</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Mortality Rate per 100,000 Person Years"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Population Size"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Racialized Groups'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Population Size and Mortality Rates by ZCTA, Age Group and Racialized Group"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/raw_rates_scatter.png"), width = 16, height = 8)</span></code></pre></div>
<div class="inline-figure">This figure shows a series of maps of the COVID-19 mortality rate per 100,000 person years between 2020-2022, by age and racialied groups.
<img src="images/09-cook-county-covid/raw_rates_by_zcta.png" width="100%">
</div>
<div class="inline-figure">This figure shows a series of maps highlighting the underlying population at risk in each strata.
<img src="images/09-cook-county-covid/population_size_by_zcta.png" width="100%">
</div>
<div class="inline-figure">This figure shows the histogram of these rates to visualizate the distribution of the data.
<img src="images/09-cook-county-covid/raw_rates_histogram.png" width="100%">
</div>
<div class="inline-figure">This figure shows the relationship between mortality rates and population size in each strata.
<img src="images/09-cook-county-covid/raw_rates_scatter.png" width="100%">
</div>
<p>You can see that there are a number of zero-counts, and that rates are noisier when population sizes are smaller.</p>
<div class="infobox interpretation">
<p>The figure above illustrates that there is a lot more variability of mortality rates at the ZCTA-level when the population count is small. Thus we need to be careful when interpreting extreme values obtained in small areas.</p>
</div>
<div class="infobox communication">
<p>A map of crude rates of small areas with low person-time at risk may be misleading. It may identify some areas as having extreme rates, but this may be just due to chance and low population at risk.</p>
</div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># in the following visualizations the motivating principle behind the direction of the </span>
<span class="co"># color palette is to show (for sequential palettes) higher density with darker colors; </span>
<span class="co"># for the ICEraceinc variable a divergent color palette is used to draw attention to the </span>
<span class="co"># extreme ends of the scale</span>

<span class="co"># visualize the proportional racial/ethnic breakdown</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">prop_black</span>, <span class="va">prop_white_nh</span>, <span class="va">prop_hispanic</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>
    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">prop_black</span>, <span class="va">prop_white_nh</span>, <span class="va">prop_hispanic</span><span class="op">)</span>,
    names_to <span class="op">=</span> <span class="st">"race_ethnicity"</span>,
    values_to <span class="op">=</span> <span class="st">'proportion'</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    race_ethnicity <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">race_ethnicity</span>, 
                            prop_white_nh <span class="op">=</span> <span class="st">'White, non-Hispanic'</span>,
                            prop_black <span class="op">=</span> <span class="st">'Black, Hispanic or non-Hispanic'</span>,
                            prop_hispanic <span class="op">=</span> <span class="st">'Hispanic'</span>
                            <span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">proportion</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>
    palette <span class="op">=</span> <span class="st">"Greens"</span>,
    direction <span class="op">=</span> <span class="fl">1</span>,
    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html">percent_format</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Population Percentage"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Composition in Relation to Racialized Groups"</span>,
          subtitle <span class="op">=</span> <span class="st">"ZCTAs in Cook County (including Chicago); Data from ACS 2015-2019"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/racial_ethnic_composition.png", width = 12, height = 8)</span>

<span class="co"># visualize median income</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">median_income</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="fl">1</span>, 
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Median Income'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Median Income"</span>,
          subtitle <span class="op">=</span> <span class="st">"ZCTAs in Cook County (including Chicago); Data from ACS 2015-2019"</span><span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/median_income.png", width = 8, height = 8)</span>

<span class="co"># visualize ICEraceinc</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">ICEraceinc</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'PRGn'</span>, direction <span class="op">=</span> <span class="fl">1</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">number_format</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"High Income (&gt;$100k annual household income) White non-Hispanic (high) vs.\n"</span>,
                     <span class="st">"Low Income (&lt;$25k annual household income) People of Color (low)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Index of Concentration at the Extremes for Racialized Economic Segregation"</span>,
          <span class="st">"ZCTAs in Cook County (including Chicago); Data from ACS 2015-2019"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html">guide_colourbar</a></span><span class="op">(</span>
    title.position <span class="op">=</span> <span class="st">"top"</span>,
    title.hjust <span class="op">=</span> <span class="fl">0.5</span>,
    barwidth <span class="op">=</span> <span class="fl">10</span>
    
  <span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/ICEraceinc.png", width = 8, height = 8)</span>


<span class="co"># visualize crowding </span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">crowding</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="fl">1</span>, 
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html">percent_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"% Household Crowding"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Household Crowding"</span>,
          <span class="st">"ZCTAs in Cook County (including Chicago); Data from ACS 2015-2019"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/crowding.png", width = 8, height = 8)</span>


<span class="co"># visualize poverty</span>
<span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">prop_in_poverty</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'Purples'</span>, direction <span class="op">=</span> <span class="fl">1</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="cn">NA</span><span class="op">)</span>,
                       labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html">percent_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">'Poverty Level'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Poverty Level"</span>,
          subtitle <span class="op">=</span> <span class="st">"ZCTAs in Cook County (including Chicago); Data from ACS 2015-2019"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/poverty.png", width = 8, height = 8)</span></code></pre></div>
<p>The code above produces a series of maps that visualize the different ABSMs we will use in this analysis. Note that Chicago is situated in Cook County.
<img src="images/09-cook-county-covid/racial_ethnic_composition.png" width="100%"><img src="images/09-cook-county-covid/median_income.png" width="100%"><img src="images/09-cook-county-covid/ICEraceinc.png" width="100%"><img src="images/09-cook-county-covid/crowding.png" width="100%"><img src="images/09-cook-county-covid/poverty.png" width="100%"></p>
<div class="infobox interpretation">
<p>In contrast to the other ABSMs, the Index of Concentration at the Extremes (ICE) highlights racialized economic segregation (i.e., race/ethnicity + income). It measures the extent to which an area’s population is concentrated into extremes of deprivation and privilege. It is scaled from -1 to 1: a value of -1 means that 100% of the population is concentrated in the most deprived group (in this analysis, conceptualized as the population of color in low-income households), and a value of 1 means that 100% of the population is concentrated into the most privileged group (in this analysis, conceptualized as the White non-Hispanic population in high-income households).</p>
</div>
<div class="infobox communication">
<p>The maps above utilize various color scales. How do you think this can affect communication through maps? Do you have a preference? When might you use a diverging versus continuous color scale? Sometimes in can also be useful to plot an interactive map, shown below.</p>
</div>
<p>We can utilize the mapview package to plot interactive graphs.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># launch an interactive map to view Cook County ICEraceinc by zip code</span>
<span class="co"># mapview::mapview(df, zcol = "ICEraceinc")</span></code></pre></div>
<iframe src="data/09-cook-county-covid/ICEraceinc_widget.html" width="100%" height="500px">
</iframe>
</div>
<div id="analyzing-the-data" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> Analyzing the data<a class="anchor" aria-label="anchor" href="#analyzing-the-data"><i class="fas fa-link"></i></a>
</h2>
<div id="differences-in-covid-19-mortality-rates-by-racialized-group" class="section level3" number="8.7.1">
<h3>
<span class="header-section-number">8.7.1</span> Differences in COVID-19 mortality rates by racialized group<a class="anchor" aria-label="anchor" href="#differences-in-covid-19-mortality-rates-by-racialized-group"><i class="fas fa-link"></i></a>
</h3>
<p>First, we can take a look at the COVID-19 mortality rates by racialized group in aggregate. Because we are aggregating up to the County level, we are not looking at gradients by ABSMs.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Since we are not taking into account ABSMs in this first analysis, aggregate the data and visualize</span>
<span class="va">crude_mortality</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#dplyr works faster if we drop the geometry column.</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span>, <span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>population_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population_estimate</span><span class="op">)</span>,
            deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>,
            person_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">person_time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mortality_per100k_py <span class="op">=</span> <span class="op">(</span><span class="va">deaths</span> <span class="op">/</span> <span class="va">person_time</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span><span class="op">)</span>

<span class="co">#plot clude mortality and confidence intervals</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">crude_mortality</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">age_group</span>,
      color <span class="op">=</span> <span class="va">race_ethnicity</span>,
      y <span class="op">=</span> <span class="va">mortality_per100k_py</span>,
      ymin <span class="op">=</span> <span class="fu">epitools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/epitools/man/pois.conf.int.html">pois.exact</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">deaths</span>, pt<span class="op">=</span><span class="va">person_time</span>, conf.level<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">*</span><span class="fl">1e5</span>,
      ymax <span class="op">=</span> <span class="fu">epitools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/epitools/man/pois.conf.int.html">pois.exact</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">deaths</span>, pt<span class="op">=</span><span class="va">person_time</span>, conf.level<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">*</span><span class="fl">1e5</span>, <span class="co">#CIs calculated using pos.exact from epitools package</span>
      shape <span class="op">=</span> <span class="va">race_ethnicity</span>
    <span class="op">)</span>,
    position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Age Group"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Mortality per 100,000 person years"</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Racialized Group'</span>, shape <span class="op">=</span> <span class="st">'Racialized Group'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Mortality Rates by Racialized Group"</span>,
          subtitle <span class="op">=</span> <span class="st">"Poisson Model Confidence Intervals Shown"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># ggsave("./images/09-cook-county-covid/crude_rates_by_raceethnicity.png", width = 8, height = 6)</span></code></pre></div>
<div class="infobox interpretation">
<p>There are racialized disparities in mortality across all age groups. How would you interpret this, and is this what you expected to see? Why or why not?</p>
</div>
<div class="inline-figure"><img src="images/09-cook-county-covid/crude_rates_by_raceethnicity.png" width="100%"></div>
<p>We can fit models to the aggregate data to adjust for age and obtain relative risk estimates.</p>
<div class="infobox dataWrangling">
<p>We can fit Poisson, Quasi-Poisson, and Negative Binomial models here, depending on our assumptions about overdispersion. The code below fits the different models and plots them together to demonstrate how modeling assumptions may affect the results. Doing this repeatedly for various analysis can be tedious. One idea could be to write a function that fits all three models given a dataset and model specifications.</p>
</div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Fit a Poisson model with offset for person time to get rate</span>
<span class="va">crude_poisson_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">race_ethnicity</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">person_time</span> <span class="op">/</span> <span class="fl">1e5</span><span class="op">)</span><span class="op">)</span>,
                           data <span class="op">=</span> <span class="va">crude_mortality</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Quasipoisson model</span>
<span class="va">crude_quasipoisson_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">race_ethnicity</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">person_time</span> <span class="op">/</span> <span class="fl">1e5</span><span class="op">)</span><span class="op">)</span>,
                           data <span class="op">=</span> <span class="va">crude_mortality</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'log'</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Negative binomial model from MASS package</span>
<span class="va">crude_negbin_model</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">race_ethnicity</span> <span class="op">+</span> <span class="va">age_group</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">person_time</span> <span class="op">/</span> <span class="fl">1e5</span><span class="op">)</span><span class="op">)</span>,
                           data <span class="op">=</span> <span class="va">crude_mortality</span><span class="op">)</span> <span class="co">##The MASS package is used to fit the negative binomial model</span>

<span class="co"># extract the model coefficients</span>
<span class="va">crude_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="co">#The tidy function from broom makes it easy to extract useful model outputs</span>
  <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">crude_poisson_model</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Poisson"</span><span class="op">)</span>,
  <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">crude_quasipoisson_model</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Quasi-Poisson"</span><span class="op">)</span>,
  <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">crude_negbin_model</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Negative Binomial"</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span>, <span class="va">conf.low</span>, <span class="va">conf.high</span>, <span class="va">Model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">'(Intercept)'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Remove the intercept term</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#Clean up the names of variables</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"race_ethnicity"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="co">#Clean up names of variables</span>

<span class="co">#Plot model results on same plot to compare</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">crude_results</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
         x <span class="op">=</span> <span class="va">estimate</span>,
         xmax <span class="op">=</span> <span class="va">conf.high</span>, <span class="co">#for confidence interval error bars</span>
         xmin <span class="op">=</span> <span class="va">conf.low</span>,
         y <span class="op">=</span> <span class="va">term</span>,
         color <span class="op">=</span> <span class="va">Model</span>, <span class="co">#Color, fill, shape grouped by model type.</span>
         fill <span class="op">=</span> <span class="va">Model</span>,
         shape <span class="op">=</span> <span class="va">Model</span>,
         group <span class="op">=</span> <span class="va">Model</span>
       <span class="op">)</span>
<span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span> <span class="co">#Line to represent RR Of 1</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co">#pointrange plots confidence interval and estimate</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>,
    n.breaks <span class="op">=</span> <span class="fl">4</span>,
    trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Racialized Group"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Modeled Incident Rate Ratios"</span>,
          subtitle <span class="op">=</span> <span class="st">"White, Non-Hispanic is the reference racialized group"</span><span class="op">)</span>

<span class="co"># ggsave("./images/09-cook-county-covid/modeled_IRR_by_raceethnicity.png", width = 6, height = 4)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/modeled_IRR_by_raceethnicity.png" width="100%"></div>
<div class="infobox interpretation">
<p>The Poisson and Quasi-Poisson models have the same point estimate but the confidence interval from the Quasi-Poisson model is much greater. The Negative Binomial models have different point estimates and confidence intervals. Is this what you expected? Why or why not?</p>
</div>
<div class="infobox communication">
<p>When presenting, it would likely be easier to communicate these results by showing results from one type of model.</p>
</div>
</div>
<div id="gradients-in-covid-19-mortality-by-in-relation-to-absms" class="section level3" number="8.7.2">
<h3>
<span class="header-section-number">8.7.2</span> Gradients in COVID-19 mortality by in relation to ABSMs<a class="anchor" aria-label="anchor" href="#gradients-in-covid-19-mortality-by-in-relation-to-absms"><i class="fas fa-link"></i></a>
</h3>
<p>Having looked at overall racialized disparities in COVID-19 mortality, let us now take a look at how mortality varies by ABSMs. Like in the section above, we take age into account by adjusting for age in the model. We fit separate models for each ABSM we are considering.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## We will aggregate data across racialized groups since we are looking at overall relationships</span>
<span class="va">age_ZCTA_mortality</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>population_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population_estimate</span><span class="op">)</span>,
            deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>,
            person_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">person_time</span><span class="op">)</span>,
            ICEraceinc_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">ICEraceinc_cut</span><span class="op">)</span>, <span class="co">#The ABSMs are the same for every strata in each ZCTA, so we can just take the first one.</span>
            prop_in_poverty_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">prop_in_poverty_cut</span><span class="op">)</span>,
            median_income_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">median_income_cut</span><span class="op">)</span>,
            crowding_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">crowding_cut</span><span class="op">)</span>,
            prop_black_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">prop_black_cut</span><span class="op">)</span>,
            prop_hispanic_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">prop_hispanic_cut</span><span class="op">)</span>,
            prop_white_nh_cut <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">prop_white_nh_cut</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mortality_per100k_py <span class="op">=</span> <span class="op">(</span><span class="va">deaths</span> <span class="op">/</span> <span class="va">person_time</span><span class="op">)</span><span class="op">*</span><span class="fl">100000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>race_ethnicity<span class="op">=</span><span class="st">"All"</span><span class="op">)</span>

<span class="co"># specify our variables of interest</span>
<span class="va">variables_of_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ICEraceinc_cut"</span>,
      <span class="st">"prop_in_poverty_cut"</span>,
      <span class="st">"median_income_cut"</span>,
      <span class="st">"crowding_cut"</span>,
      <span class="st">"prop_black_cut"</span>,
      <span class="st">"prop_hispanic_cut"</span>,
      <span class="st">"prop_white_nh_cut"</span><span class="op">)</span>

<span class="co"># specify our model formulae with each variable of interest</span>
<span class="va">model_formula</span> <span class="op">&lt;-</span> 
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">variables_of_interest</span>,
    <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"deaths ~ "</span>,
             <span class="va">.</span>, <span class="st">" + age_group + offset(log(person_time / 1e5))"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># set the names of the model formulae accordingly </span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">model_formula</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">variables_of_interest</span>

<span class="co"># estimate overall models</span>
<span class="va">overall_models</span> <span class="op">&lt;-</span> 
  <span class="va">age_ZCTA_mortality</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>
      <span class="va">.</span>,
      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'log'</span><span class="op">)</span>,
      data <span class="op">=</span> <span class="va">data</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>
      <span class="va">.</span>,
      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'log'</span><span class="op">)</span>,
      data <span class="op">=</span> <span class="va">data</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">.</span>,
                               data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># extract the model coefficients</span>
<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">poisson</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, 
  quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">quasipoisson</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, 
  negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">negbin</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># insert names for which model distribution they're associated with</span>
<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">poisson</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">poisson</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">quasipoisson</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">quasipoisson</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">negbin</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">negbin</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># pivot longer so that each row represents a model coefficient</span>
<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>
  cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">poisson</span>, <span class="va">quasipoisson</span>, <span class="va">negbin</span><span class="op">)</span>,
  names_to <span class="op">=</span> <span class="st">'model'</span>,
  values_to <span class="op">=</span> <span class="st">'coefficients'</span>
<span class="op">)</span>

<span class="co"># unnest the list column for coefficients</span>
<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">coefficients</span><span class="op">)</span>
<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">coefficients</span><span class="op">)</span>

<span class="va">overall_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">'(Intercept)'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">exposure_var</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="co">#mutate(exposure_var = stringr::str_replace_all(exposure_var, "_", " ")) %&gt;% </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposure_var <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">exposure_var</span>, 
                               crowding_cut <span class="op">=</span> <span class="st">"Household Crowding"</span>,
                               ICEraceinc_cut <span class="op">=</span> <span class="st">"ICE for Racialized Economic Segregation"</span>,
                               median_income_cut <span class="op">=</span> <span class="st">"Median Income"</span>,
                               prop_hispanic_cut <span class="op">=</span> <span class="st">"Proportion Hispanic"</span>,
                               prop_black_cut <span class="op">=</span> <span class="st">"Proportion Black, Hispanic and non-Hispanic"</span>,
                               prop_white_nh_cut <span class="op">=</span> <span class="st">"Proportion White, non-Hispanic"</span>,
                               prop_in_poverty_cut <span class="op">=</span> <span class="st">"Proportion in Poverty"</span>
                               <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposure_var <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op">(</span><span class="va">exposure_var</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"(?&lt;=[\\(\\[])(.*)(?=,)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">-</span><span class="va">term_size</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">estimate</span>,
      xmax <span class="op">=</span> <span class="va">conf.high</span>,
      xmin <span class="op">=</span> <span class="va">conf.low</span>,
      y <span class="op">=</span> <span class="va">term</span>,
      color <span class="op">=</span> <span class="va">model</span>,
      fill <span class="op">=</span> <span class="va">model</span>,
      shape <span class="op">=</span> <span class="va">model</span>,
      group <span class="op">=</span> <span class="va">model</span>  
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">exposure_var</span><span class="op">~</span><span class="va">.</span>, scales<span class="op">=</span><span class="st">'free_y'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>
    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>,
    n.breaks <span class="op">=</span> <span class="fl">4</span>,
    trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Weighted Quantile (excluding the Reference Category)"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Incident Rate Ratios"</span>,
          subtitle <span class="op">=</span> <span class="st">"Separate Models Fit for Each Categorical Exposure"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/exposure_coefficient_estimates_ecological.png"), width = 8, height = 8)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/exposure_coefficient_estimates_ecological.png" width="100%"></div>
</div>
<div id="gradients-in-covid-19-mortality-by-racialized-group-in-relation-to-absms" class="section level3" number="8.7.3">
<h3>
<span class="header-section-number">8.7.3</span> Gradients in COVID-19 mortality by Racialized Group in relation to ABSMs<a class="anchor" aria-label="anchor" href="#gradients-in-covid-19-mortality-by-racialized-group-in-relation-to-absms"><i class="fas fa-link"></i></a>
</h3>
<p>Now we can take a look at how mortality varies in relation to ABSMs, by racialized group. We build on the code in the section above, but now have models for each racialized group and each ABSM.</p>
<div class="infobox dataWrangling">
<p>Here we fit the three types of models, for three racialized groups, and for seven ABSMs. Writing out 3x3x7 models would take up space and time, and be prone to mistakes. The code below uses the <code>map</code> function from the <code>purrr</code> package to do this more efficiently. Do you agree with this approach? What are some other ways you would approach this?</p>
<p>You can change to code to focus in on fewer ABSMs or investigate other ABSMs of interest for the presentation.</p>
</div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify our variables of interest</span>
<span class="va">variables_of_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ICEraceinc_cut"</span>,
      <span class="st">"prop_in_poverty_cut"</span>,
      <span class="st">"median_income_cut"</span>,
      <span class="st">"crowding_cut"</span>,
      <span class="st">"prop_black_cut"</span>,
      <span class="st">"prop_hispanic_cut"</span>,
      <span class="st">"prop_white_nh_cut"</span><span class="op">)</span>

<span class="co"># specify our model formulae with each variable of interest</span>
<span class="va">model_formula</span> <span class="op">&lt;-</span> 
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">variables_of_interest</span>,
    <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"deaths ~ "</span>,
             <span class="va">.</span>, <span class="st">" + age_group + offset(log(person_time / 1e5))"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># set the names of the model formulae accordingly </span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">model_formula</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">variables_of_interest</span>

<span class="co"># estimate race/ethnicity stratified models</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op">&lt;-</span> 
  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>
      <span class="va">.</span>,
      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'log'</span><span class="op">)</span>,
      data <span class="op">=</span> <span class="va">data</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span>
      <span class="va">.</span>,
      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'log'</span><span class="op">)</span>,
      data <span class="op">=</span> <span class="va">data</span>
    <span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model_formula</span>, <span class="op">~</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">.</span>,
                               data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># extract the model coefficients</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">poisson</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, 
  quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">quasipoisson</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, 
  negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">negbin</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># insert names for which model distribution they're associated with</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
  poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">poisson</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">poisson</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  quasipoisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">quasipoisson</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">quasipoisson</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  negbin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">negbin</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">negbin</span><span class="op">[[</span><span class="va">.</span><span class="op">]</span><span class="op">]</span>, exposure_var <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># pivot longer so that each row represents a model coefficient</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>
  cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">poisson</span>, <span class="va">quasipoisson</span>, <span class="va">negbin</span><span class="op">)</span>,
  names_to <span class="op">=</span> <span class="st">'model'</span>,
  values_to <span class="op">=</span> <span class="st">'coefficients'</span>
<span class="op">)</span>

<span class="co"># unnest the list column for coefficients</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">coefficients</span><span class="op">)</span>
<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">coefficients</span><span class="op">)</span>

<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">'(Intercept)'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">exposure_var</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="co">#mutate(exposure_var = stringr::str_replace_all(exposure_var, "_", " ")) %&gt;% </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposure_var <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">exposure_var</span>, 
                               crowding_cut <span class="op">=</span> <span class="st">"Household Crowding"</span>,
                               ICEraceinc_cut <span class="op">=</span> <span class="st">"ICE for Racialized Economic Segregation"</span>,
                               median_income_cut <span class="op">=</span> <span class="st">"Median Income"</span>,
                               prop_hispanic_cut <span class="op">=</span> <span class="st">"Proportion Hispanic"</span>,
                               prop_black_cut <span class="op">=</span> <span class="st">"Proportion Black, Hispanic and non-Hispanic"</span>,
                               prop_white_nh_cut <span class="op">=</span> <span class="st">"Proportion White, non-Hispanic"</span>,
                               prop_in_poverty_cut <span class="op">=</span> <span class="st">"Proportion in Poverty"</span>
                               <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>exposure_var <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_wrap.html">str_wrap</a></span><span class="op">(</span><span class="va">exposure_var</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"(?&lt;=[\\(\\[])(.*)(?=,)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">term</span>, <span class="op">-</span><span class="va">term_size</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">estimate</span>,
      xmax <span class="op">=</span> <span class="va">conf.high</span>,
      xmin <span class="op">=</span> <span class="va">conf.low</span>,
      y <span class="op">=</span> <span class="va">term</span>,
      color <span class="op">=</span> <span class="va">model</span>,
      fill <span class="op">=</span> <span class="va">model</span>,
      shape <span class="op">=</span> <span class="va">model</span>,
      group <span class="op">=</span> <span class="va">model</span>  
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">4</span>, trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">exposure_var</span><span class="op">~</span><span class="va">race_ethnicity</span>, scales<span class="op">=</span><span class="st">'free_y'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Incident Rate Ratios"</span>,
          subtitle <span class="op">=</span> <span class="st">"Separate Models Fit for Each Categorical Exposure and Racialized Group"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/exposure_coefficient_estimates.png"), width = 14, height = 18)</span>

<span class="va">race_ethnicity_stratified_models</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">'(Intercept)'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">estimate</span>,
      xmax <span class="op">=</span> <span class="va">conf.high</span>,
      xmin <span class="op">=</span> <span class="va">conf.low</span>,
      y <span class="op">=</span> <span class="va">term</span>,
      color <span class="op">=</span> <span class="va">model</span>,
      fill <span class="op">=</span> <span class="va">model</span>,
      shape <span class="op">=</span> <span class="va">model</span>,
      group <span class="op">=</span> <span class="va">model</span> 
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">4</span>, trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">exposure_var</span><span class="op">~</span><span class="va">race_ethnicity</span>, scales<span class="op">=</span><span class="st">'free_y'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Incident Rate Ratios"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/age_coefficient_estimates.png"), width = 14, height = 18)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/exposure_coefficient_estimates.png" width="100%"></div>
<div class="infobox communication">
<p>The various models and ABSMs are shown for demonstration. However, it may be better to focus on one particular aspect (e.g. a particular ABSM and model), driven by a specific question and understanding of the context. What would you focus on and why?</p>
</div>
</div>
<div id="hierarchical-and-spatial-models" class="section level3" number="8.7.4">
<h3>
<span class="header-section-number">8.7.4</span> Hierarchical and Spatial Models<a class="anchor" aria-label="anchor" href="#hierarchical-and-spatial-models"><i class="fas fa-link"></i></a>
</h3>
<div id="background-1" class="section level4" number="8.7.4.1">
<h4>
<span class="header-section-number">8.7.4.1</span> Background<a class="anchor" aria-label="anchor" href="#background-1"><i class="fas fa-link"></i></a>
</h4>
<p>In the examples above, we modeled the associations between individual- and area-based measures with the outcome in aggregate across the county. However, we may also be interested in modeling the risk of mortality in each ZCTA. This can help us better understand the spatial distribution of risk.</p>
<p>We may also want to take into account the fact that these ZCTAs are likely not independent of each other, but rather related to each other in a spatially structured fashion. That is, ZCTAs that are next to each other are more likely to have similar rates than ZCTAs that are farther apart.</p>
<p>One of the <em>statistical</em> challenges of estimating the risk in each ZCTA (or any other small areal unit), is that, due to small underlying populations and sparse events interspersed in time, small-area estimation (SAE) of risk and incidence rates can be quite unstable. This has led to the use of various strategies to smooth estimates, by borrowing information from nearby spatial units. Thus, by accounting for the fact that ZCTAs that are closer together are more likely to be similar, we can obtain spatially smoothed risk estimates.</p>
<p>Put another way: let us say that a particular part of the county has high mortality rates. If we look at observations over a limited period of time, in each specific ZCTA separately, we may miss this just by chance due to the fact that the populations in individual ZCTAs are small, and thus fewer events are observed. However, if we pool information from neighboring ZCTAs, we would be able to obtain a more stable estimate of the risk.</p>
<p>Hierarchical Bayesian models are a popular set of tools to conduct such estimations. Often, in such approaches, we will model the Standardized Mortality Ratio (SMR), standardized by age. The relative risk or SMR in area <span class="math inline">\(i\)</span>, (<span class="math inline">\(\theta_i\)</span>) is obtained by dividing the expected count (<span class="math inline">\(E_i\)</span>) by the observed count <span class="math inline">\(O_i\)</span>). How we calculate the “expected count” depends on the objectives of our study and analysis. For example, if we know that there are strong age effects, and want to estimate excess risk after accounting for age-composition differences between ZCTAs, we can take the age-strata-specific mortality rates for all of Cook County, and apply it to the age-distribution of each ZCTA. This tells us what the “expected” mortality count would be if each ZCTA experienced Cook County’s average age-specific mortality rates. One could also standardize by composition in relation to racialized groups, but then we would not be able to estimate how membership in racialized groups was associated with mortality. Similarly, age-standardization precludes the ability to look at the interaction between age and membership in racialized groups, for example.</p>
</div>
<div id="smr-calculation" class="section level4" number="8.7.4.2">
<h4>
<span class="header-section-number">8.7.4.2</span> SMR Calculation<a class="anchor" aria-label="anchor" href="#smr-calculation"><i class="fas fa-link"></i></a>
</h4>
<p>In this case, we will estimate the SMR using age-standardization. For each racialized group in each ZCTA, we obtain the age standardized SMR.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## We will need to have a ZCTA specific ID number that starts from 1 eventually, so let's first make that</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geoid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
  

<span class="co">## Calculate overall age-specific mortality</span>
<span class="va">overall_mortality</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_drop_geometry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>,
            person_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">person_time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mortality_per_py <span class="op">=</span> <span class="op">(</span><span class="va">deaths</span><span class="op">/</span><span class="va">person_time</span><span class="op">)</span><span class="op">)</span>


<span class="co">## Apply this to each ZCTA</span>
<span class="va">smr_df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_drop_geometry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">overall_mortality</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age_group"</span>, <span class="st">"mortality_per_py"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="st">"age_group"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#Join the overall age-specific mortality rates</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Exp <span class="op">=</span> <span class="va">mortality_per_py</span> <span class="op">*</span> <span class="va">person_time</span>, <span class="co">#Multiply the overall age-specific mortality to the person-time in each ZCTA-race-age strata %&gt;%</span>
         Obs <span class="op">=</span> <span class="va">deaths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">id</span>, <span class="va">race_ethnicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>Exp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span>,
            Obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Obs</span><span class="op">)</span>,
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">ICEraceinc</span><span class="op">:</span><span class="va">prop_white_nh_cut</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>raw_SMR <span class="op">=</span> <span class="va">Obs</span><span class="op">/</span><span class="va">Exp</span>,
         raw_CI95low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epitools/man/pois.conf.int.html">pois.exact</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Obs</span>, pt<span class="op">=</span><span class="va">Exp</span>, conf.level<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>,
         raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epitools/man/pois.conf.int.html">pois.exact</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Obs</span>, pt<span class="op">=</span><span class="va">Exp</span>, conf.level<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">)</span> <span class="co">#calculate 95% CI bounds based on Poisson parameters </span></code></pre></div>
<p>So, in our dataset we can calculate the Observed count <span class="math inline">\(O_i\)</span>, the Expected count <span class="math inline">\(E_i\)</span> (based on age standardization), and the SMR <span class="math inline">\(\theta_i\)</span>. The observed count approximately follows a Poisson distribution, such that:</p>
<p><span class="math display">\[
O_i \sim Poisson(\theta_i*E_i)
\]</span></p>
<p>That is, the observed county in any one ZCTA follows a Poisson distribution whose mean is the expected county times a relative risk / SMR. We are interested in this last component since it quantifies the “excess” or “reduced” risk in each area beyond what is “expected” by an age-composition. In our particular case, since we actually have strata of racialized groups within each ZCTA, we can create a hierarchical structure such that:</p>
<p><span class="math display">\[
O_{ij} \sim Poisson(\theta_{ij}*E_{ij})
\]</span></p>
<p>Now, we are looking at observed, expected counts and SMR within each racialized group strata <span class="math inline">\(j\)</span>, within each ZCTA <span class="math inline">\(i\)</span>.</p>
<p>Let us visualize these crude SMRs for each ZCTA-racialized group strata, along with their confidence intervals</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">raw_SMR</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
                raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">raw_CI95up</span> <span class="op">&gt;</span> <span class="fl">40</span>, <span class="fl">40</span>, <span class="va">raw_CI95up</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Since there are large confidence intervals, we are going to cut them off at 40 for easier visualization.</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">order_id</span>, y <span class="op">=</span> <span class="va">raw_SMR</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">order_id</span>, ymin <span class="op">=</span> <span class="va">raw_CI95low</span>, ymax <span class="op">=</span> <span class="va">raw_CI95up</span><span class="op">)</span>,
                size<span class="op">=</span><span class="fl">0.2</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">40</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Crude SMR"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"ZCTA-Racialized Group strata"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/raw_SMR_caterpillar.png"), height = 6, width = 8)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/raw_SMR_caterpillar.png" width="100%"></div>
<p>Here we can see that there is large variability in these strata-specific SMRs, as well as large confidence intervals for many strata — especially when the predicted rate is zero.</p>
</div>
<div id="fitting-models" class="section level4" number="8.7.4.3">
<h4>
<span class="header-section-number">8.7.4.3</span> Fitting Models<a class="anchor" aria-label="anchor" href="#fitting-models"><i class="fas fa-link"></i></a>
</h4>
<p>Instead of just calculating the crude SMRs, we can model them using a Poisson log-normal model such that:</p>
<p><span class="math display">\[
log(\theta_{ij}) = \beta_0 + v_i \\
where \ v_i \sim Normal(0,\sigma^2_v)
\]</span></p>
<p>Here there is a county-wide intercept <span class="math inline">\(\beta_0\)</span>, and ZCTA random effects <span class="math inline">\(v_i\)</span> that quantify the excess/reduced risk in each area from the county-wide average. Note that this is not a spatial model and we are still assuming that the ZCTAs are independent of each other.</p>
<p>However, this model does not have any fixed effects for individual-level variables, so we are estimating the same SMR for each racialized group strata within each ZCTA. We may do just this if we did not have any individual-level data. However, in our case, we are interested in estimating the effect of membership in racialized groups, and we can include that in the fixed part of the model such that:</p>
<p><span class="math display">\[
log(\theta_{ij}) = \beta_0 + \mathbf{\beta}(race\_ethnicity_j) + v_i \\
where \ v_i \sim Normal(0,\sigma^2_v)
\]</span>
Here, there is a county-wide intercept for a reference racialized group <span class="math inline">\(\beta_0\)</span>, <span class="math inline">\(\beta\)</span>s for each other racialized group. Note that here we are modeling a constant effect for each racialized group across all ZCTAs.</p>
<p>Let us fit this model</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">formula_poisson_mod1</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">race_ethnicity</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">geoid</span>, model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>

<span class="va">model_poisson_mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_poisson_mod1</span>, family<span class="op">=</span><span class="st">"poisson"</span>, data<span class="op">=</span><span class="va">smr_df</span>, E<span class="op">=</span><span class="va">Exp</span>, control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="co">#The control.compute option here calculates the Deviance Information Criteria which we could use to assess model fit, especially when comparing different formulations</span>
<span class="co">#The control.predictor option here computes the predicted values</span>

<span class="co"># Save the fitted SMRs and their confidence intervals for each ZCTA into the dataframe we have.</span>
<span class="va">smr_df</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poissonmod1_SMR <span class="op">=</span> <span class="va">model_poisson_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         poissonmod1_CI95low <span class="op">=</span> <span class="va">model_poisson_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         poissonmod1_CI95up <span class="op">=</span> <span class="va">model_poisson_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_poisson_mod1</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">geoid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geoid"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>poissonmod1_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></code></pre></div>
<p>Next, as mentioned before, we may want to take into account the fact that neighboring ZCTAs are more closely related. One way to do this is to fit a “Besag-York-Mollie” or BYM model. This builds on the previous model, and partitions the random effects into two components - a spatially structured one, and a spatially structured one. A BYM model would be:</p>
<p><span class="math display">\[
log(\theta_{ij}) = \beta_0 + \mathbf{\beta}(race/ethnicity) + u_i + v_i \\
where \ v_i \sim Normal(0,\sigma^2_v) \ and \\
u_i \sim Conditional \ Autoregressive(W, \sigma_u^2)
\]</span></p>
<p>What this specifies is that the part of the residual variation across the ZCTAs is spatially structured such that neighboring ZCTAs have similar excess risks. This part is indicated by the new <span class="math inline">\(u_i\)</span> introduced above. After accounting for the spatial structure, further residual variation is indicated by <span class="math inline">\(v_i\)</span>. After fitting such models, we can also calculate the proportion of the residual variance that is spatially structured (that is, <span class="math inline">\(u_i\)</span>), and this is known as the spatial fraction.</p>
<p>Let us fit this model:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Calculate Neighbours matrix</span>
<span class="va">W.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>, snap<span class="op">=</span><span class="fl">0.001</span><span class="op">)</span>
<span class="co">#W.list &lt;- nb2listw(W.nb, style="B", zero.policy = TRUE)</span>

<span class="co"># Visualize the neighbourhood matrix</span>
<span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">W.nb</span>, <span class="va">coords</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="co">#Make adjacency matrix in format INLA can understand</span>
<span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2INLA.html">nb2INLA</a></span><span class="op">(</span><span class="st">"INLA_adj_mat"</span>, <span class="va">W.nb</span><span class="op">)</span> <span class="co">#this saves a file in the working directory</span>
<span class="va">INLA_adj_mat</span> <span class="op">&lt;-</span> <span class="st">"INLA_adj_mat"</span>

<span class="va">formula_bym_mod1</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">race_ethnicity</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_mod1</span>, family<span class="op">=</span><span class="st">"poisson"</span>, data<span class="op">=</span><span class="va">smr_df</span>, E<span class="op">=</span><span class="va">Exp</span>, 
                       control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                       control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save the fitted model estimates and Confidence intervals into the dataframe</span>
<span class="va">smr_df</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmod1_SMR <span class="op">=</span> <span class="va">model_bym_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmod1_CI95low <span class="op">=</span> <span class="va">model_bym_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmod1_CI95up <span class="op">=</span> <span class="va">model_bym_mod1</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_mod1</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmod1_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="co">## Calculate Spatial Fraction</span>
<span class="co"># This is a bit verbose, and INLA does not come with a built-in function to calculate this. </span>
<span class="co"># Going to create a function to calculate this</span>

<span class="va">spatial_frac</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inla_model</span>, <span class="va">numarea</span><span class="op">)</span><span class="op">{</span>
  <span class="va">mat.marg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">numarea</span>, ncol<span class="op">=</span><span class="fl">100000</span><span class="op">)</span> <span class="co">#create empty matrix</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">inla_model</span><span class="op">$</span><span class="va">marginals.random</span><span class="op">$</span><span class="va">id</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numarea</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#the first block of the random effects matrix contains area-specific effects (u + v), </span>
  <span class="co">#and the second block contains spatially structured residuals (u). </span>
  <span class="co">#So this is extracting from the second block of rows</span>
    <span class="va">u</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">[[</span><span class="va">numarea</span><span class="op">+</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> 
    <span class="va">mat.marg</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.rmarginal</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="va">u</span><span class="op">)</span> <span class="co">#randomly pick 100000 values from posterior distributions of area-specific spatially structures residuals</span>
    <span class="op">}</span>
<span class="co">#Get empirical variance from 100000 obs</span>
  <span class="va">var.u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">mat.marg</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span> 

<span class="co">#Get unstructured variance</span>
  <span class="va">var.v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.rmarginal</a></span><span class="op">(</span><span class="fl">100000</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">/</span><span class="va">x</span>, 
                                         <span class="va">inla_model</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">$</span><span class="va">`Precision for id`</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Calculate spatially structured variance percentage</span>
  <span class="va">perc.var.u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">var.u</span><span class="op">/</span><span class="op">(</span><span class="va">var.u</span><span class="op">+</span><span class="va">var.v</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">perc.var.u</span><span class="op">)</span>
<span class="op">}</span>


<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_mod1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="comparing-fitted-smrs" class="section level4" number="8.7.4.4">
<h4>
<span class="header-section-number">8.7.4.4</span> Comparing Fitted SMRs<a class="anchor" aria-label="anchor" href="#comparing-fitted-smrs"><i class="fas fa-link"></i></a>
</h4>
<p>Having fit all of these models, let us visualize all of their components and see what we gain from using these different types of models, and how they differ.</p>
<p>First, we can look at the the estimates of the fixed effects. Since our non-hierarchical models also estimated fixed effects, we can include them in this comparison, with the caveat that we are modeling SMRs in the hierarchical models.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#The tidy functions from broom work on most commonly used models in R, but INLA is not one of them. </span>
<span class="co">#This is a helper function to extract coefficients and credible/"confidence" intervals.</span>
<span class="va">tidy.inla</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  
  <span class="co"># x = model_inla</span>
  <span class="va">term_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">)</span>

  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>terms <span class="op">=</span> <span class="va">term_names</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>term <span class="op">=</span> <span class="va">terms</span>,
                  estimate <span class="op">=</span> <span class="va">mean</span>,
                  std.error <span class="op">=</span> <span class="va">sd</span>,
                  conf.low <span class="op">=</span> <span class="va">`0.025quant`</span>, 
                  conf.high <span class="op">=</span> <span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">estimate</span>, <span class="va">std.error</span>,
                  <span class="va">conf.low</span>, <span class="va">conf.high</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">coefficients_together</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">crude_results</span>,
            <span class="fu">tidy.inla</span><span class="op">(</span><span class="va">model_poisson_mod1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Hierarchical Poisson"</span>,
                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">:</span><span class="va">conf.high</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu">tidy.inla</span><span class="op">(</span><span class="va">model_bym_mod1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"BYM"</span>,
                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">:</span><span class="va">conf.high</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"race_ethnicity"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># visualize the effects in each model</span>
<span class="va">coefficients_together</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">'(Intercept)'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"age_group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, xmax <span class="op">=</span> <span class="va">conf.high</span>, xmin <span class="op">=</span> <span class="va">conf.low</span>, y <span class="op">=</span> <span class="va">term</span>, color <span class="op">=</span> <span class="va">Model</span>, shape <span class="op">=</span> <span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width<span class="op">=</span><span class="fl">.45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing Coefficient Estimates for Racialized Groups from Different Models"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/coefficient_comparison.png"), height = 6, width = 8)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/coefficient_comparison.png" width="100%"></div>
<p>One of the motivations for fitting the hierarchical models is to get stable and smoothed estimates of each ZCTA. Let us visualize the modeled SMRs for each ZCTA-racialized group strata, along with their confidence intervals, and compare them to the crude SMRs we calculated in the beginning.</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Creating a caterpillar plot to visualize the unsmoothed and smoothed SMRs.</span>
<span class="va">caterpillar_plot</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">raw_SMR</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
         raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">raw_CI95up</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="fl">10</span>, <span class="va">raw_CI95up</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_RE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="co">#Pivot longer to help with ggplot</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">raw_SMR</span><span class="op">:</span><span class="va">bymmod1_CI95up</span>, 
               names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SMR_type"</span>, <span class="st">".value"</span><span class="op">)</span>,
               names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>SMR_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">SMR_type</span> <span class="op">==</span> <span class="st">"bymmod1"</span>, <span class="st">"BYM"</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">SMR_type</span> <span class="op">==</span> <span class="st">"poissonmod1"</span>, <span class="st">"Hierarchical Poisson"</span>,
                                  <span class="st">"Raw"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">caterpillar_plot</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">order_id</span>, y <span class="op">=</span> <span class="va">SMR</span>, color <span class="op">=</span> <span class="va">SMR_type</span>, 
                 group <span class="op">=</span> <span class="va">SMR_type</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">order_id</span>, ymin <span class="op">=</span> <span class="va">CI95low</span>, ymax <span class="op">=</span> <span class="va">CI95up</span>, color <span class="op">=</span> <span class="va">SMR_type</span>, 
                 group <span class="op">=</span> <span class="va">SMR_type</span><span class="op">)</span>,
                size<span class="op">=</span><span class="fl">0.2</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">SMR_type</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Estimated and Crude SMRs"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"ZCTA-Racialized Group strata"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"SMR Type"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Raw and Modeled SMRs for each ZCTA-Racialized Group strata"</span><span class="op">)</span>
  

<span class="co"># ggsave(here("images/09-cook-county-covid/caterpillar_plot_SMRs.png"), width = 9, height = 6)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/caterpillar_plot_SMRs.png" width="100%"></div>
<div class="infobox interpretation">
<p>These caterpillar plots demonstrates the noisiness of the raw SMRs. Note that we cut off the y-axis range here to allow comparison within a limited range. Both models smooth the SMRs.</p>
</div>
<div class="infobox communication">
<p>These plots also demonstrates the pitfalls of identifying small areas with extreme rates based on crude SMRs only. They may have a small underlying population, and have high confidence intervals.</p>
</div>
<p>The hierarchical models can be most useful when we visualize the estimated ZCTA-specific effects. Since we have racialized group strata within ZCTAs, we can plot maps for each group.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Similar code as for the caterpillar plot above, but we are going to plot just the point estimates on a map, and not the CIs</span>
<span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">raw_SMR</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
         raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">raw_CI95up</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="fl">10</span>, <span class="va">raw_CI95up</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_RE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">raw_SMR</span><span class="op">:</span><span class="va">bymmod1_CI95up</span>, 
               names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SMR_type"</span>, <span class="st">".value"</span><span class="op">)</span>,
               names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">geometry</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"geoid"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>sf_column_name <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>SMR_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">SMR_type</span> <span class="op">==</span> <span class="st">"bymmod1"</span>, <span class="st">"BYM"</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">SMR_type</span> <span class="op">==</span> <span class="st">"poissonmod1"</span>, <span class="st">"Hierarchical Poisson"</span>,
                                  <span class="st">"Raw"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">SMR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">~</span><span class="va">SMR_type</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"BrBG"</span>,
                       trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span>, 
                       oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>,
        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">75</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Raw and Modeled SMR Maps"</span><span class="op">)</span>

<span class="co"># ggsave(here("images/09-cook-county-covid/modeled_SMR_comparison_1.png"), width = 10, height = 8)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/modeled_SMR_comparison_1.png" width="100%"></div>
<p>The spatial fraction is 72%.</p>
<div class="infobox interpretation">
<p>What we see here is that the crude calculated SMRs are very noisy. Using the Poisson hierarchical and BYM models has clear benefits in smoothing the rates. However, there does not seem to be that much difference, at a high level, between the Poisson hierarchical and BYM model.</p>
</div>
<p>** IMPORTANT NOTE **
:::: {.infobox .interpretation}
When we look at these smoothed maps, we can see that the risk is lowest for the White non-Hispanic group. However, the spatial patterning of risk is similar for each racialized group in the maps. We should be cautious about concluding from this that the spatial patterning is the same. It is the result of how we constrained the model, as we did not model the spatial component separately for each group. We are going to do this next by fitting a separate models for each racialized group.
::::</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fitting the models for the White Non-Hispanic group</span>
<span class="va">smr_df_wnh</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"White, non-Hispanic"</span><span class="op">)</span>
<span class="co">#Poisson</span>
<span class="va">formula_poisson_wnh</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">geoid</span>, model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>

<span class="va">model_poisson_wnh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_poisson_wnh</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_wnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co"># As above for the overall models, save the fitted values and CIs</span>
<span class="va">smr_df_wnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_wnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poissonmodspecific_SMR <span class="op">=</span> <span class="va">model_poisson_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         poissonmodspecific_CI95low <span class="op">=</span> <span class="va">model_poisson_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         poissonmodspecific_CI95up <span class="op">=</span> <span class="va">model_poisson_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_poisson_wnh</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">geoid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geoid"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>poissonmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>


<span class="co">#BYM</span>
<span class="va">formula_bym_wnh</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_wnh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_wnh</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_wnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save fitted values from model</span>
<span class="va">smr_df_wnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_wnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific_SMR <span class="op">=</span> <span class="va">model_bym_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific_CI95low <span class="op">=</span> <span class="va">model_bym_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific_CI95up <span class="op">=</span> <span class="va">model_bym_wnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_wnh</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_wnh</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_wnh</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Fitting Black Hispanic and non-Hispanic groups</span>
<span class="va">smr_df_bhnh</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"Black, Hispanic or non-Hispanic"</span><span class="op">)</span>
<span class="co">#Poisson</span>
<span class="va">formula_poisson_bhnh</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">geoid</span>, model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>

<span class="va">model_poisson_bhnh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_poisson_bhnh</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_bhnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save fitted values from model</span>
<span class="va">smr_df_bhnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_bhnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poissonmodspecific_SMR <span class="op">=</span> <span class="va">model_poisson_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         poissonmodspecific_CI95low <span class="op">=</span> <span class="va">model_poisson_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         poissonmodspecific_CI95up <span class="op">=</span> <span class="va">model_poisson_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_poisson_bhnh</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">geoid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geoid"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>poissonmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>


<span class="co">#BYM</span>
<span class="va">formula_bym_bhnh</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_bhnh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_bhnh</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_bhnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save fitted values from model</span>
<span class="va">smr_df_bhnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_bhnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific_SMR <span class="op">=</span> <span class="va">model_bym_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific_CI95low <span class="op">=</span> <span class="va">model_bym_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific_CI95up <span class="op">=</span> <span class="va">model_bym_bhnh</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_bhnh</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_bhnh</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_bhnh</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Fitting Hispanic Group</span>
<span class="va">smr_df_h</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"Hispanic"</span><span class="op">)</span>
<span class="co">#Poisson</span>
<span class="va">formula_poisson_h</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">geoid</span>, model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>

<span class="va">model_poisson_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_poisson_h</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_h</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save fitted values from model</span>
<span class="va">smr_df_h</span> <span class="op">&lt;-</span> <span class="va">smr_df_h</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>poissonmodspecific_SMR <span class="op">=</span> <span class="va">model_poisson_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         poissonmodspecific_CI95low <span class="op">=</span> <span class="va">model_poisson_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         poissonmodspecific_CI95up <span class="op">=</span> <span class="va">model_poisson_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_poisson_h</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">geoid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geoid"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>poissonmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>


<span class="co">#BYM</span>
<span class="va">formula_bym_h</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_h</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_h</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co">#Save fitted values from model</span>
<span class="va">smr_df_h</span> <span class="op">&lt;-</span> <span class="va">smr_df_h</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific_SMR <span class="op">=</span> <span class="va">model_bym_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific_CI95low <span class="op">=</span> <span class="va">model_bym_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific_CI95up <span class="op">=</span> <span class="va">model_bym_h</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_h</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_h</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_h</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The spatial fraction of the residual variance is 61% for the White, non-Hispanic model; 67.8% for the Black; Hispanic and non-Hispanic model; and 77% for the Hispanic model.</p>
<p>We can visualize the smoothed SMRs from these separate models.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Combine all of the racialized group specific results into one</span>
<span class="va">smr_df</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">smr_df_wnh</span>, <span class="va">smr_df_bhnh</span>, <span class="va">smr_df_h</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">race_ethnicity</span>, <span class="va">poissonmodspecific_SMR</span><span class="op">:</span><span class="va">bymmodspecific_RE</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geoid"</span>, <span class="st">"race_ethnicity"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Similar to how we plotted the maps for overall fitted SMRs in each ZCTA, we do the same by racialized group</span>
<span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">raw_SMR</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
         raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">raw_CI95up</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="fl">10</span>, <span class="va">raw_CI95up</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_RE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">raw_SMR</span><span class="op">:</span><span class="va">raw_CI95up</span>, <span class="va">poissonmodspecific_SMR</span><span class="op">:</span><span class="va">bymmodspecific_CI95up</span><span class="op">)</span>, 
               names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SMR_type"</span>, <span class="st">".value"</span><span class="op">)</span>,
               names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">geometry</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"geoid"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>sf_column_name <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>SMR_type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">SMR_type</span>,
                           bymmodspecific <span class="op">=</span> <span class="st">"BYM"</span>, 
                           poissonmodspecific <span class="op">=</span> <span class="st">"Hierarchical Poisson"</span>,
                           raw <span class="op">=</span> <span class="st">"Raw"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">SMR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">~</span><span class="va">SMR_type</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"BrBG"</span>,
                       trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span>, 
                       oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'right'</span>, 
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Modeled SMR Maps"</span>, subtitle <span class="op">=</span> <span class="st">"Each Racialized Group Modeled Separately"</span><span class="op">)</span> 

<span class="co"># ggsave(here("images/09-cook-county-covid/modeled_SMR_race_specific.png"), width = 12, height = 8)</span></code></pre></div>
<div class="inline-figure">
<img src="images/09-cook-county-covid/modeled_SMR_race_specific.png" width="100%">
This approach reflects the different spatial patterning of risks for each racialized group, while also smoothing rates.</div>
</div>
<div id="additional-analysis" class="section level4" number="8.7.4.5">
<h4>
<span class="header-section-number">8.7.4.5</span> Additional Analysis<a class="anchor" aria-label="anchor" href="#additional-analysis"><i class="fas fa-link"></i></a>
</h4>
<p>We may also be interested in looking at the area-specific <strong>residuals</strong>. These give us a sense of how much each areas risk deviates from the county-wide mean, conditional on any covariates we include in the model. We can visualize the residuals of the models above (where no covariates were included).</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">raw_SMR</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Exp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>order_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
         raw_CI95up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">raw_CI95up</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="fl">10</span>, <span class="va">raw_CI95up</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_SMR"</span>, <span class="st">"_CI95up"</span>, <span class="st">"_CI95low"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">poissonmodspecific_RE</span><span class="op">:</span><span class="va">bymmodspecific_RE</span><span class="op">)</span>, 
               names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RE_type"</span>, <span class="st">".value"</span><span class="op">)</span>,
               names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geoid</span>, <span class="va">geometry</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"geoid"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>sf_column_name <span class="op">=</span> <span class="st">"geometry"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>SMR_type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">RE_type</span>,
                           bymmodspecific <span class="op">=</span> <span class="st">"BYM"</span>, 
                           poissonmodspecific <span class="op">=</span> <span class="st">"Hierarchical Poisson"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">RE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">race_ethnicity</span><span class="op">)</span><span class="op">~</span><span class="va">SMR_type</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"BrBG"</span>,
                       trans <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/log_trans.html">pseudo_log_trans</a></span><span class="op">(</span>sigma<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span>, 
                       oob <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/oob.html">squish</a></span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'right'</span>, 
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Residual SMR"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"ZCTA-specific model residuals"</span>, subtitle <span class="op">=</span> <span class="st">"Each Racialized Group Modeled Separately"</span><span class="op">)</span> 

<span class="co"># ggsave(here("images/09-cook-county-covid/model_residuals_race_specific.png"), width = 9, height = 8)</span></code></pre></div>
<div class="inline-figure"><img src="images/09-cook-county-covid/model_residuals_race_specific.png" width="100%"></div>
<p>Finally, as in the non-hierarchical models above, we can also add ABSMs to these hierarchical models. The model would be as follows:</p>
<p><span class="math display">\[
log(\theta_{ij}) = \beta_0 + \mathbf{\beta}(ABSM_i) + u_i + v_i \\
where \ v_i \sim Normal(0,\sigma^2_v) \ ,\  and \\
u_i \sim Conditional \ Autoregressive(W, \sigma_u^2)
\]</span></p>
<p>Let us fit this model, using only the ICE for racialized economic segregation as the ABSM of interest:</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fitting the models for the White Non-Hispanic group</span>
<span class="va">smr_df_wnh</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"White, non-Hispanic"</span><span class="op">)</span>
<span class="co">#BYM</span>
<span class="va">formula_bym_wnh2</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">ICEraceinc_cut</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_wnh2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_wnh2</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_wnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>


<span class="va">smr_df_wnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_wnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific2_SMR <span class="op">=</span> <span class="va">model_bym_wnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific2_CI95low <span class="op">=</span> <span class="va">model_bym_wnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific2_CI95up <span class="op">=</span> <span class="va">model_bym_wnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_wnh2</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific2_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_wnh2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_wnh</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Fitting Black Hispanic and non-Hispanic groups</span>
<span class="va">smr_df_bhnh</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"Black, Hispanic or non-Hispanic"</span><span class="op">)</span>

<span class="co">#BYM</span>
<span class="va">formula_bym_bhnh2</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">ICEraceinc_cut</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_bhnh2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_bhnh2</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_bhnh</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>


<span class="va">smr_df_bhnh</span> <span class="op">&lt;-</span> <span class="va">smr_df_bhnh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific2_SMR <span class="op">=</span> <span class="va">model_bym_bhnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific2_CI95low <span class="op">=</span> <span class="va">model_bym_bhnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific2_CI95up <span class="op">=</span> <span class="va">model_bym_bhnh2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_bhnh2</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific2_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_bhnh2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_bhnh</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Fitting Hispanic Group</span>
<span class="va">smr_df_h</span> <span class="op">&lt;-</span> <span class="va">smr_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">race_ethnicity</span> <span class="op">==</span> <span class="st">"Hispanic"</span><span class="op">)</span>

<span class="co">#BYM</span>
<span class="va">formula_bym_h2</span> <span class="op">&lt;-</span> <span class="va">Obs</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">ICEraceinc_cut</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>, model<span class="op">=</span><span class="st">"bym2"</span>, graph<span class="op">=</span><span class="va">INLA_adj_mat</span>, scale.model<span class="op">=</span><span class="cn">TRUE</span>, constr<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="va">model_bym_h2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula_bym_h2</span>, family<span class="op">=</span><span class="st">"poisson"</span>, 
                          data <span class="op">=</span> <span class="va">smr_df_h</span>, E<span class="op">=</span><span class="va">Exp</span>,
                          control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, 
                          control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>


<span class="va">smr_df_h</span> <span class="op">&lt;-</span> <span class="va">smr_df_h</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bymmodspecific2_SMR <span class="op">=</span> <span class="va">model_bym_h2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span>,
         bymmodspecific2_CI95low <span class="op">=</span> <span class="va">model_bym_h2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.025quant`</span>,
         bymmodspecific2_CI95up <span class="op">=</span> <span class="va">model_bym_h2</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">`0.975quant`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">model_bym_h2</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">=</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bymmodspecific2_RE <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>

<span class="fu">spatial_frac</span><span class="op">(</span><span class="va">model_bym_h2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">smr_df_h</span><span class="op">$</span><span class="va">geoid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="breast-cancer-mortality.html"><span class="header-section-number">7</span> Case Study 2: Breast Cancer Mortality in Massachusetts</a></div>
<div class="next"><a href="temporal-health-insurance.html"><span class="header-section-number">9</span> Case Study 4: Case Study on Temporal Trends using American Community Survey (ACS) data (2012-2019)</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#cook-county-covid"><span class="header-section-number">8</span> Case Study 3: COVID-19 Mortality in Cook County (March 2020 - March 2022)</a></li>
<li><a class="nav-link" href="#introduction-1"><span class="header-section-number">8.1</span> Introduction</a></li>
<li><a class="nav-link" href="#motivation-research-questions-and-learning-objectives-2"><span class="header-section-number">8.2</span> Motivation, Research Questions, and Learning Objectives</a></li>
<li><a class="nav-link" href="#approach-2"><span class="header-section-number">8.3</span> Approach</a></li>
<li><a class="nav-link" href="#dependencies-2"><span class="header-section-number">8.4</span> Dependencies</a></li>
<li>
<a class="nav-link" href="#cleaning-the-data"><span class="header-section-number">8.5</span> Cleaning the Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#denominator-data"><span class="header-section-number">8.5.1</span> Denominator Data</a></li>
<li><a class="nav-link" href="#case-data"><span class="header-section-number">8.5.2</span> Case Data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#visualizing-your-data-1"><span class="header-section-number">8.6</span> Visualizing Your Data</a></li>
<li>
<a class="nav-link" href="#analyzing-the-data"><span class="header-section-number">8.7</span> Analyzing the data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#differences-in-covid-19-mortality-rates-by-racialized-group"><span class="header-section-number">8.7.1</span> Differences in COVID-19 mortality rates by racialized group</a></li>
<li><a class="nav-link" href="#gradients-in-covid-19-mortality-by-in-relation-to-absms"><span class="header-section-number">8.7.2</span> Gradients in COVID-19 mortality by in relation to ABSMs</a></li>
<li><a class="nav-link" href="#gradients-in-covid-19-mortality-by-racialized-group-in-relation-to-absms"><span class="header-section-number">8.7.3</span> Gradients in COVID-19 mortality by Racialized Group in relation to ABSMs</a></li>
<li><a class="nav-link" href="#hierarchical-and-spatial-models"><span class="header-section-number">8.7.4</span> Hierarchical and Spatial Models</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Public Health Disparities Geocoding Project 2.0 Training Manual</strong>" was written by Christian Testa, Jarvis T Chen, Enjoli Hall, Dena Javadi, Justin Morgan, Tamara Rushovich, Sudipta (Shu) Saha, Pamela D Waterman, Nancy Krieger. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
